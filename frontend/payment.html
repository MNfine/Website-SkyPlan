<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="paymentTitle">SkyPlan - Thanh to√°n</title>

  <!-- Favicon -->
  <link rel="icon" href="assets/images/favicon.svg" type="image/svg+xml">
  <link rel="alternate icon" href="favicon.ico" type="image/x-icon">

  <!-- Font Awesome CDN for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- CSS -->
  <link rel="stylesheet" href="assets/styles/reset.css">
  <link rel="stylesheet" href="assets/styles/index.css">
  <link rel="stylesheet" href="assets/styles/flags.css">
  <link rel="stylesheet" href="assets/styles/header.css">
  <link rel="stylesheet" href="assets/styles/footer.css">
  <link rel="stylesheet" href="assets/styles/payment.css">
  <link rel="stylesheet" href="assets/styles/loader.css">
</head>
<body>
  <!-- Header -->
  <div id="header-container"></div>

  <!-- Progress Bar -->
  <div class="container payment-flow">
    <div class="steps">
      <div class="step completed">
        <div class="dot">1</div>
        <div class="label" data-i18n="step1">T√¨m ki·∫øm</div>
      </div>
      <div class="step completed">
        <div class="dot">2</div>
        <div class="label" data-i18n="step2">Ch·ªçn chuy·∫øn bay</div>
      </div>
      <div class="step completed">
        <div class="dot">3</div>
        <div class="label" data-i18n="step3">Ch·ªçn gi√°</div>
      </div>
      <div class="step completed">
        <div class="dot">4</div>
        <div class="label" data-i18n="step4">Th√¥ng tin kh√°ch h√†ng</div>
      </div>
      <div class="step completed">
        <div class="dot">5</div>
        <div class="label" data-i18n="step5">D·ªãch v·ª• th√™m</div>
      </div>
      <div class="step active">
        <div class="dot">6</div>
        <div class="label" data-i18n="step6">Thanh to√°n</div>
      </div>
      <div class="progress"></div>
    </div>

    <!-- Main Content -->
    <div class="payment-content">
      <div class="payment-container">
        <!-- Left Column - Payment Methods -->
        <div class="payment-section">
          <div class="section-header">
            <h2><i class="fas fa-credit-card"></i> <span data-i18n="paymentMethod">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</span></h2>
          </div>

          <div class="some-payment-methods">
            <!-- Row 1: Credit/Debit Card (Full Width) -->
            <div class="payment-row">
              <div class="payment-method active full-width">
                <input type="radio" id="card" name="payment" value="card" checked />
                <label for="card" class="method-header">
                  <i class="fas fa-credit-card"></i>
                  <span data-i18n="cardMethod">Th·∫ª t√≠n d·ª•ng / Th·∫ª ghi n·ª£</span>
                </label>

                <div class="method-content">
                  <div class="card-logos">
                    <img src="assets/images/visa.png" alt="Visa" class="card-logo" />
                    <img src="assets/images/mastercard.png" alt="Mastercard" class="card-logo" />
                    <img src="assets/images/jcb.png" alt="JCB" class="card-logo" />
                  </div>

                  <form class="card-form">
                    <div class="form-group">
                      <label for="cardNumber" data-i18n="cardNumber">S·ªë th·∫ª</label>
                      <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" />
                    </div>

                    <div class="form-row">
                      <div class="form-group">
                        <label for="expiryDate" data-i18n="expiryDate">Ng√†y h·∫øt h·∫°n</label>
                        <input type="text" id="expiryDate" placeholder="MM/YY" maxlength="5" />
                      </div>
                      <div class="form-group">
                        <label for="cvv" data-i18n="cvv">CVV</label>
                        <input type="text" id="cvv" placeholder="123" maxlength="4" />
                      </div>
                    </div>

                    <div class="form-group">
                      <label for="cardName" data-i18n="cardHolder">T√™n tr√™n th·∫ª</label>
                      <input type="text" id="cardName" placeholder="NGUYEN VAN A" />
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Row 2: Bank Transfer & E-Wallet (Two Columns) -->
            <div class="payment-row two-columns">
              <!-- Bank Transfer -->
              <div class="payment-method">
                <input type="radio" id="bank" name="payment" value="bank" />
                <label for="bank" class="method-header">
                  <i class="fas fa-university"></i>
                  <span data-i18n="bank">Ng√¢n h√†ng</span>
                </label>
                <div class="method-content">
                    <div class="bank-info">
                    <p><strong data-i18n="bankNameLabel">Ng√¢n h√†ng:</strong> Vietcombank</p>
                    <p><strong data-i18n="accountNumberLabel">S·ªë t√†i kho·∫£n:</strong> 1234567890</p>
                    <p><strong data-i18n="accountNameLabel">T√™n t√†i kho·∫£n:</strong> CONG TY SKYPLAN</p>
                    <p><strong data-i18n="transferContentLabel">N·ªôi dung:</strong> <span data-i18n="transferExample">[M√£ ƒë·∫∑t v√©] - [H·ªç t√™n]</span></p>
                  </div>
                </div>
              </div>

              <!-- E-Wallet -->
              <div class="payment-method">
                <input type="radio" id="ewallet" name="payment" value="ewallet" />
                <label for="ewallet" class="method-header">
                  <i class="fas fa-mobile-alt"></i>
                  <span data-i18n="ewallet">V√≠ ƒëi·ªán t·ª≠</span>
                </label>
                <div class="method-content">
                  <div class="ewallet-info">
                    <p><strong data-i18n="paymentGuide">H∆∞·ªõng d·∫´n thanh to√°n:</strong></p>
                    <div class="ewallet-steps">
                      <p data-i18n="scanOrTransfer">1. Qu√©t m√£ QR ho·∫∑c chuy·ªÉn ti·ªÅn theo th√¥ng tin:</p>
                      <p><strong data-i18n="phoneLabel">S·ªë ƒëi·ªán tho·∫°i:</strong> 0123 456 789</p>
                      <p><strong data-i18n="nameLabel">T√™n:</strong> CONG TY SKYPLAN</p>
                      <p><strong data-i18n="transferContentLabel">N·ªôi dung:</strong> <span data-i18n="transferExample">[M√£ ƒë·∫∑t v√©] - [H·ªç t√™n]</span></p>
                      <p data-i18n="chooseWallet">2. Ch·ªçn v√≠ ƒëi·ªán t·ª≠ ph√π h·ª£p:</p>
                    </div>

                    <div class="ewallet-options">
                      <button class="ewallet-btn" data-wallet="momo">
                        <img src="assets/images/momo.png" alt="MoMo" class="ewallet-logo" />
                        <span data-i18n="momo">MoMo</span>
                      </button>
                      <button class="ewallet-btn" data-wallet="zalopay">
                        <img src="assets/images/zalopay.png" alt="ZaloPay" class="ewallet-logo" />
                        <span data-i18n="zalopay">ZaloPay</span>
                      </button>
                      <button class="ewallet-btn active" data-wallet="vnpay">
                        <img src="assets/images/vnpay.png" alt="VNPay" class="ewallet-logo" />
                        <span data-i18n="vnpay">VNPay (Kh·∫£ d·ª•ng)</span>
                      </button>
                    </div>

                    <!-- VNPay Integration Form -->
                    <div class="vnpay-form" id="vnpayForm" style="display: none;">
                      <div class="vnpay-info">
                        <h4><i class="fas fa-shield-alt"></i> <span data-i18n="vnpayTitle">Thanh to√°n qua VNPay</span></h4>
                        <p data-i18n="vnpayDesc">B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang thanh to√°n VNPay ƒë·ªÉ ho√†n t·∫•t giao d·ªãch.</p>

                        <div class="payment-details">
                          <div class="detail-row">
                            <span data-i18n="totalAmount">S·ªë ti·ªÅn:</span>
                            <strong>1.598.000 VND</strong>
                          </div>
                          <div class="detail-row">
                            <span data-i18n="bookingCode">M√£ ƒë·∫∑t v√©:</span>
                            <strong id="bookingCode">SP2025001</strong>
                          </div>
                          <div class="detail-row">
                            <span data-i18n="content">N·ªôi dung:</span>
                            <strong>Ve may bay HAN-SGN</strong>
                          </div>
                        </div>

                        <button class="vnpay-checkout-btn" onclick="processVNPayPayment()">
                          <i class="fas fa-credit-card"></i>
                          <span data-i18n="payWithVnpay">Thanh to√°n v·ªõi VNPay</span>
                        </button>
                      </div>
                    </div>
                    <!-- /VNPay -->
                  </div>
                </div>
              </div>
              <!-- /E-Wallet -->
            </div>
            <!-- /Row 2 -->
          </div>
          <!-- /payment-methods -->
        </div>
        <!-- /payment-section -->

        <!-- Right Column - Order Summary (NOW inside .payment-container) -->
        <div class="summary-section">
          <div class="section-header">
            <h2><i class="fas fa-receipt"></i> <span data-i18n="orderSummary">T√≥m t·∫Øt ƒë∆°n h√†ng</span></h2>
          </div>

          <div class="order-summary">
            <div class="booking-details">
              <div class="flight-summary">
                <h4 data-i18n="route1">H√† N·ªôi ‚Üí H·ªì Ch√≠ Minh</h4>
                <p data-i18n="route1Time">Ng√†y 10 thg 6, 2023 - 10:45 ‚Üí 13:00</p>
                <p data-i18n="route1Class">Ph·ªï th√¥ng ‚Ä¢ 1 h√†nh kh√°ch</p>
              </div>

              <div class="flight-summary">
                <h4 data-i18n="route2">H·ªì Ch√≠ Minh ‚Üí H√† N·ªôi</h4>
                <p data-i18n="route2Time">Ng√†y 18 thg 8, 2023 - 16:20 ‚Üí 18:30</p>
                <p data-i18n="route2Class">Ph·ªï th√¥ng ‚Ä¢ 1 h√†nh kh√°ch</p>
              </div>
            </div>

            <div class="price-breakdown">
              <div class="price-item">
                <span data-i18n="ticketLabel">V√© m√°y bay (2 chi·ªÅu)</span>
                <span id="baseAmount">0 VND</span>
              </div>
              <div class="price-item">
                <span data-i18n="taxLabel">Thu·∫ø v√† ph√≠</span>
                <span id="taxAmount">200.000 VND</span>
              </div>
              <div class="price-item total">
                <span data-i18n="totalLabel">T·ªïng c·ªông</span>
                <span id="totalAmount">0 VND</span>
              </div>
            </div>

            <!-- Voucher Section -->
            <div class="voucher-section">
              <h4 data-i18n="voucherTitle">M√£ gi·∫£m gi√°</h4>
              <div class="voucher-input-group">
                <input type="text" id="voucherCode" placeholder="Nh·∫≠p m√£ voucher" data-i18n="voucherPlaceholder">
                <button type="button" id="applyVoucher" class="voucher-btn" data-i18n="applyVoucher">√Åp d·ª•ng</button>
              </div>
              <div id="voucherMessage" class="voucher-message"></div>
              <div class="available-vouchers">
                <small data-i18n="availableVouchers">M√£ kh·∫£ d·ª•ng: XMAS10, NOEL200, EARLY200</small>
              </div>
              
              <div class="voucher-discount hidden" id="voucherDiscount">
                <div class="price-item discount">
                  <span data-i18n="discountLabel">Gi·∫£m gi√°</span>
                  <span id="discountAmount">-0 VND</span>
                </div>
                <div class="price-item final-total">
                  <span data-i18n="finalTotalLabel">T·ªïng thanh to√°n</span>
                  <span id="finalAmount">0 VND</span>
                </div>
              </div>
            </div>

            <button class="pay-btn" id="mainPayBtn">
              <i class="fas fa-lock"></i>
              <span id="mainPayBtnText" data-i18n="payNow">Thanh to√°n ngay</span>
            </button>

            <div class="security-info">
              <i class="fas fa-shield-alt"></i>
              <span data-i18n="secure">Giao d·ªãch ƒë∆∞·ª£c b·∫£o m·∫≠t b·∫±ng SSL 256-bit</span>
            </div>
          </div>
        </div>
        <!-- /summary-section -->
      </div>
      <!-- /payment-container -->
    </div>
    <!-- /payment-content -->
  </div>
  <!-- /container payment-flow -->

  <!-- Footer -->
  <div id="footer-container"></div>

  <!-- JavaScript -->
  <script src="assets/scripts/common.js"></script>
  <script src="assets/scripts/overview_translations.js"></script>
  <script src="assets/scripts/payment_translations.js"></script>
  <script src="assets/scripts/payment_order.js"></script>
  <script src="assets/scripts/auth-utils.js"></script>
  <script>
    // T·ª± ƒë·ªông d·ªãch khi trang load
    document.addEventListener('DOMContentLoaded', function() {
      const lang = localStorage.getItem('preferredLanguage') || 'vi';
      if (typeof applyPaymentTranslations === 'function') {
        applyPaymentTranslations(lang);
      }
      
      // Ch·∫°y payment order render sau khi translations ƒë√£ xong
      setTimeout(() => {
        if (typeof window.renderPaymentOrder === 'function') {
          window.renderPaymentOrder();
        }
      }, 200);
    });
  </script>
  <script src="assets/scripts/config.js"></script>
  <script src="assets/scripts/payment.js"></script>
  <script src="assets/scripts/payment_vnpay.js"></script>
<script>
  // Ch·ªâ hi·ªÉn th·ªã ƒë√∫ng 1 n√∫t ph√π h·ª£p v·ªõi ph∆∞∆°ng th·ª©c thanh to√°n, lu√¥n d·ªãch text n√∫t
  document.addEventListener('DOMContentLoaded', function() {
    const bankRadio = document.getElementById('bank');
    const cardRadio = document.getElementById('card');
    const ewalletRadio = document.getElementById('ewallet');
    const mainPayBtn = document.getElementById('mainPayBtn');
    const mainPayBtnText = document.getElementById('mainPayBtnText');
    const radios = document.querySelectorAll('input[name="payment"]');
    function updatePayBtn() {
      try {
        const lang = localStorage.getItem('preferredLanguage') || 'vi';
        if (!mainPayBtn) return;
        // Card
        if (cardRadio && cardRadio.checked) {
          mainPayBtn.style.display = '';
          mainPayBtn.style.background = '';
          if (mainPayBtnText) {
            if (mainPayBtnText) mainPayBtnText.dataset && (mainPayBtnText.dataset.i18n = 'payNow');
            if (typeof getPaymentTranslation === 'function') {
              mainPayBtnText.textContent = getPaymentTranslation('payNow', lang);
            } else if (typeof applyPaymentTranslations === 'function') {
              applyPaymentTranslations(lang);
            }
          }
          // show/remove lock icon depending on card form validity
          try {
            const valid = (typeof isCardFormValid === 'function') ? isCardFormValid() : false;
            const iconEl = mainPayBtn.querySelector('i');
            if (valid) {
              if (iconEl) iconEl.remove();
            } else {
              if (!iconEl) {
                const newI = document.createElement('i');
                newI.className = 'fas fa-lock';
                mainPayBtn.insertBefore(newI, mainPayBtn.firstChild);
              } else {
                iconEl.className = 'fas fa-lock';
              }
            }
          } catch (e) { /* ignore */ }
          mainPayBtn.onclick = null;
          return;
        }
        // Bank
        if (bankRadio && bankRadio.checked) {
          mainPayBtn.style.display = '';
          mainPayBtn.style.background = '#ff9800';
          if (mainPayBtnText) {
            if (mainPayBtnText) mainPayBtnText.dataset && (mainPayBtnText.dataset.i18n = 'bankConfirm');
            if (typeof getPaymentTranslation === 'function') {
              mainPayBtnText.textContent = getPaymentTranslation('bankConfirm', lang);
            } else if (typeof applyPaymentTranslations === 'function') {
              applyPaymentTranslations(lang);
            }
          }
          mainPayBtn.onclick = function() {
            if (window.Loader) {
              window.Loader.show();
              setTimeout(function() {
                window.location.href = 'confirmation.html';
              }, 1500);
            } else {
              window.location.href = 'confirmation.html';
            }
          };
          return;
        }
        // E-wallet
        if (ewalletRadio && ewalletRadio.checked) {
          mainPayBtn.style.display = 'none';
          return;
        }
      } catch (err) {
        console.warn('updatePayBtn error', err);
      }
    }
    radios.forEach(radio => {
      radio.addEventListener('change', updatePayBtn);
    });
    // Expose globally so other scripts (common.js) can call it
    window.updatePayBtn = updatePayBtn;
    // Safely wrap or create applyPaymentTranslations so it always triggers updatePayBtn
    (function() {
      const orig = window.applyPaymentTranslations;
      window.applyPaymentTranslations = function(lang) {
        if (typeof orig === 'function') {
          try { orig(lang); } catch (e) { console.warn('applyPaymentTranslations orig error', e); }
        }
        // ensure translations applied and button updated
        try { updatePayBtn(); } catch (e) { /* ignore */ }
      };
    })();
    // initial update
    updatePayBtn();
  });
</script>


  <!-- Load Components -->
  <script>
    fetch('components/header.html')
      .then((res) => res.ok ? res.text() : Promise.reject())
      .then((html) => {
        document.getElementById('header-container').innerHTML = html;
        if (typeof initializeLanguageSelector === 'function') {
          initializeLanguageSelector();
        }
        if (typeof initializeMobileMenu === 'function') {
          initializeMobileMenu();
        }
        const lang = localStorage.getItem('preferredLanguage') || document.documentElement.lang || 'vi';
        if (typeof applyPaymentTranslations === 'function') {
          applyPaymentTranslations(lang);
        }
        if (typeof updateSelectedLanguage === 'function') {
          updateSelectedLanguage(lang);
        }
      });

    fetch('components/footer.html')
      .then((res) => res.ok ? res.text() : Promise.reject())
      .then((html) => {
        document.getElementById('footer-container').innerHTML = html;
        const lang = localStorage.getItem('preferredLanguage') || document.documentElement.lang || 'vi';
        if (typeof applyPaymentTranslations === 'function') {
          applyPaymentTranslations(lang);
        }
      });
  </script>

  <!-- Loader component (JS) -->
  <script src="assets/scripts/loader.js"></script>
  <script>
    // Import loader HTML v√†o DOM c√†ng s·ªõm c√†ng t·ªët
    fetch('components/loader.html').then(r => r.text()).then(html => {
      document.body.insertAdjacentHTML('afterbegin', html);
      // Show loader ngay khi v·ª´a insert v√†o DOM (cho F5/reload)
      if (window.Loader) {
        window.Loader.show();
        document.body.style.overflow = 'hidden';
      }
    });
    
    // ·∫®n loader khi t·∫•t c·∫£ resources ƒë√£ load xong (window.load)
    window.addEventListener('load', function() {
      setTimeout(function() {
        if (window.Loader) {
          window.Loader.hide();
          document.body.style.overflow = '';
        }
      }, 500); // Delay 500ms ƒë·ªÉ smooth
    });
  </script>

  <!-- Debug script for payment page -->
  <script>
    // Auto-create sample data if missing
    document.addEventListener('DOMContentLoaded', function() {
      const keys = ['skyplan_trip_selection', 'skyplan_fare_selection', 'skyplan_extras_v2', 'searchData'];
      let needsData = false;
      
      keys.forEach(key => {
        if (!localStorage.getItem(key)) needsData = true;
      });
      
      if (needsData) {
        console.log('üîß Creating sample data...');
        
        const sampleTrip = {
          fromCode: 'DaNang', toCode: 'HoChiMinh', 
          departDateISO: '2025-11-18', returnDateISO: '2025-11-25',
          tripType: 'round-trip',
          outboundDepartTime: '14:45', outboundArriveTime: '16:10',
          inboundDepartTime: '18:20', inboundArriveTime: '20:30',
          segments: [
            { direction: 'outbound', departTime: '14:45', arriveTime: '16:10' },
            { direction: 'inbound', departTime: '18:20', arriveTime: '20:30' }
          ]
        };
        
        const sampleFare = { fareClass: 'premium-economy', priceVND: 800000 };
        const sampleExtras = { total: 800000 };
        const sampleSearchData = { trip_type: 'round-trip', depart_date: '2025-11-18', return_date: '2025-11-25' };
        
        localStorage.setItem('skyplan_trip_selection', JSON.stringify(sampleTrip));
        localStorage.setItem('skyplan_fare_selection', JSON.stringify(sampleFare));
        localStorage.setItem('skyplan_extras_v2', JSON.stringify(sampleExtras));
        localStorage.setItem('searchData', JSON.stringify(sampleSearchData));
        
        // Add URL params
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.has('trip_type')) {
          urlParams.set('trip_type', 'round-trip');
          urlParams.set('booking_code', 'SP202545224');
          history.replaceState(null, '', window.location.pathname + '?' + urlParams.toString());
        }
        
        setTimeout(() => window.location.reload(), 500);
      }
    });
  </script>

</body>
</html>
