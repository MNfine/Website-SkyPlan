<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SkyPlane – Search Results</title>
    <link rel="stylesheet" href="assets/styles/search.css" />
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="assets/styles/reset.css">
    <link rel="stylesheet" href="assets/styles/index.css">
    <link rel="stylesheet" href="assets/styles/flags.css">
    <link rel="stylesheet" href="assets/styles/header.css">
    <link rel="stylesheet" href="assets/styles/footer.css">
</head>

<body class="with-fixed-header with-fixed-footer">
    <div id="header-container"></div>

    <main class="sp-container">
        <aside class="sp-filters" aria-label="Search filters">
            <h2 class="sp-title">Chuyến đi của bạn</h2>

            <div class="sp-field">
                <label for="from" class="sp-label">Từ</label>
                <select id="from" class="sp-input">
                    <option value="HaNoi">Hà Nội</option>
                    <option value="HoChiMinh">Hồ Chí Minh</option>
                    <option value="DaNang">Đà Nẵng</option>
                    <option value="CanTho">Cần Thơ</option>
                    <option value="LamDong">Lâm Đồng</option>
                    <option value="QuangTri">Quảng Trị</option>
                    <option value="DakLak">Đắk Lắk</option>
                    <option value="KhanhHoa">Khánh Hòa</option>
                    <option value="HaiPhong">Hải Phòng</option>
                    <option value="Hue">Huế</option>
                    <option value="DienBien">Điện Biên</option>
                    <option value="GiaLai">Gia Lai</option>
                    <option value="AnGiang">An Giang</option>
                    <option value="ThanhHoa">Thanh Hóa</option>
                    <option value="NgheAn">Nghệ An</option>
                    <option value="QuangNinh">Quảng Ninh</option>
                    <option value="SonLa">Sơn La</option>
                </select>
            </div>

            <div class="sp-field">
                <label for="to" class="sp-label">Đến</label>
                <select id="to" class="sp-input">
                    <option value="HaNoi">Hà Nội</option>
                    <option value="HoChiMinh">Hồ Chí Minh</option>
                    <option value="DaNang">Đà Nẵng</option>
                    <option value="CanTho">Cần Thơ</option>
                    <option value="LamDong">Lâm Đồng</option>
                    <option value="QuangTri">Quảng Trị</option>
                    <option value="DakLak">Đắk Lắk</option>
                    <option value="KhanhHoa">Khánh Hòa</option>
                    <option value="HaiPhong">Hải Phòng</option>
                    <option value="Hue">Huế</option>
                    <option value="DienBien">Điện Biên</option>
                    <option value="GiaLai">Gia Lai</option>
                    <option value="AnGiang">An Giang</option>
                    <option value="ThanhHoa">Thanh Hóa</option>
                    <option value="NgheAn">Nghệ An</option>
                    <option value="QuangNinh">Quảng Ninh</option>
                    <option value="SonLa">Sơn La</option>
                </select>
            </div>

            <div class="sp-trip-type">
                <label class="sp-radio">
                    <input type="radio" name="trip-type" value="round-trip" checked>
                    <span>Khứ hồi</span>
                </label>
                <label class="sp-radio">
                    <input type="radio" name="trip-type" value="one-way">
                    <span>Một chiều</span>
                </label>
            </div>
            
            <div class="sp-row sp-field-group">
                <div class="sp-field">
                    <label for="dep" class="sp-label">Ngày đi</label>
                    <input id="dep" class="sp-input" type="date" />
                </div>
                <div class="sp-field" id="return-date-field">
                    <label for="ret" class="sp-label">Ngày về</label>
                    <input id="ret" class="sp-input" type="date" />
                </div>
            </div>
            <script>
                // Thiết lập ngày mặc định là ngày hiện tại và ngày mai
                document.addEventListener('DOMContentLoaded', function() {
                    const today = new Date();
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    const formatDate = (date) => {
                        return date.toISOString().split('T')[0];
                    };
                    
                    const depInput = document.getElementById('dep');
                    const retInput = document.getElementById('ret');
                    
                    // Chỉ đặt giá trị mặc định nếu chưa có giá trị từ URL
                    if (!depInput.value) {
                        depInput.value = formatDate(today);
                    }
                    
                    if (!retInput.value) {
                        retInput.value = formatDate(tomorrow);
                    }
                });
            </script>

            <button class="sp-btn sp-btn-secondary" type="button">
                <i class="fa-solid fa-magnifying-glass"></i>
                Tìm kiếm
            </button>
            <script>
            // Khi bấm nút Tìm kiếm, lấy giá trị input và redirect với query mới
            document.addEventListener('DOMContentLoaded', function() {
                // Xử lý hiển thị trường ngày về dựa vào lựa chọn loại vé
                const tripTypeRadios = document.querySelectorAll('input[name="trip-type"]');
                const returnDateField = document.getElementById('return-date-field');
                
                // Set initial state based on URL params
                const urlParams = new URLSearchParams(window.location.search);
                const tripType = urlParams.get('type') || 'round-trip';
                
                // Set the correct radio button
                const activeRadio = document.querySelector(`input[name="trip-type"][value="${tripType}"]`);
                if (activeRadio) {
                    activeRadio.checked = true;
                }
                
                // Initial visibility
                returnDateField.style.display = tripType === 'one-way' ? 'none' : 'block';
                
                // Handle radio button change
                tripTypeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        returnDateField.style.display = this.value === 'one-way' ? 'none' : 'block';
                    });
                });
                
                const btn = document.querySelector('.sp-btn-secondary');
                if (btn) {
                    btn.addEventListener('click', function() {
                        const from = document.getElementById('from').value.trim();
                        const to = document.getElementById('to').value.trim();
                        const dep = document.getElementById('dep').value;
                        const tripType = document.querySelector('input[name="trip-type"]:checked').value;
                        
                        // Lấy giá trị ngày về chỉ khi là vé khứ hồi
                        let params = [
                            'from=' + encodeURIComponent(from),
                            'to=' + encodeURIComponent(to),
                            'dep=' + encodeURIComponent(dep),
                            'type=' + encodeURIComponent(tripType)
                        ];
                        
                        // Thêm ngày về nếu là vé khứ hồi
                        if (tripType === 'round-trip') {
                            const ret = document.getElementById('ret').value;
                            params.push('ret=' + encodeURIComponent(ret));
                        }
                        
                        window.location.search = '?' + params.join('&');
                    });
                }
            });
            </script>

            <h3 class="sp-subtitle">Bộ lọc</h3>

            <section class="sp-section">
                <div class="sp-section-title">Số điểm dừng</div>
                <label class="sp-choice"><input type="radio" name="stops" checked> Bay thẳng</label>
                <label class="sp-choice"><input type="radio" name="stops"> 1 điểm dừng</label>
                <label class="sp-choice"><input type="radio" name="stops"> 2 điểm dừng</label>
                <label class="sp-choice"><input type="radio" name="stops"> 3 điểm dừng</label>
            </section>

            <section class="sp-section">
                <div class="sp-section-title">Hành lý</div>
                <div class="sp-counter" data-counter="cabin">
                    <span>Hành lý sách tay</span>
                    <button class="sp-chip" data-minus aria-label="decrease cabin">−</button>
                    <span class="sp-count" data-value>2</span>
                    <button class="sp-chip" data-plus aria-label="increase cabin">＋</button>
                </div>
                <div class="sp-counter" data-counter="checked">
                    <span>Hành lý ký gửi</span>
                    <button class="sp-chip" data-minus aria-label="decrease checked">−</button>
                    <span class="sp-count" data-value>0</span>
                    <button class="sp-chip" data-plus aria-label="increase checked">＋</button>
                </div>
            </section>

            <section class="sp-section">
                <div class="sp-section-title">Giờ bay</div>
                <label class="sp-choice"><input type="radio" name="time" checked>5:00 - 11:49</label>
                <label class="sp-choice"><input type="radio" name="time">12:00 - 17:59</label>
                <label class="sp-choice"><input type="radio" name="time"> 18:00 - 23:59</label>
                <label class="sp-choice"><input type="radio" name="time"> 00:00 - 4:59</label>
            </section>

            <section class="sp-section">
                <div class="sp-section-title">Ngân sách</div>
                <div class="sp-price-top"><span>0 VND – 5.000.000 VND</span><span>Bất kỳ</span></div>
                <input id="priceRange" class="sp-range" type="range" max="5000000" step="50000" value="2000000" />
                <div class="sp-price-bottom"><span>0 VND</span><span id="priceOut">2.000.000 VND</span></div>
            </section>
        </aside>

        <section class="sp-results" aria-live="polite">

        </section>
    </main>

    <div id="spModal" class="sp-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="sp-modal__backdrop" data-close></div>

        <div class="sp-modal__dialog" role="document" aria-labelledby="spModalTitle">
            <div class="sp-modal__header">
                <h2 id="spModalTitle">Chi tiết chuyến bay</h2>
                <button class="sp-modal__close" aria-label="Close" data-close>&times;</button>
            </div>

            <div class="sp-modal__content">
                <!-- OUTBOUND -->
                <section class="sp-leg">
                    <div class="sp-leg__title">Đến <span data-to-city>—</span></div>
                    <div class="sp-leg__panel">
                        <div class="sp-leg__grid">
                            <div class="sp-leg__date">
                                <i class="fa-regular fa-calendar"></i>
                                <span data-out-date>—</span>
                            </div>
                            <div class="sp-leg__timeline">
                                <div class="sp-node">
                                    <div class="sp-node__time" data-out-dep-time>—</div>
                                    <div class="sp-node__icon"><i class="fa-solid fa-location-pin"></i></div>
                                    <div class="sp-node__text" data-out-dep-airport>—</div>
                                </div>
                                <div class="sp-node sp-node--plane">
                                    <div class="sp-node__time">&nbsp;</div>
                                    <div class="sp-node__icon"><i class="fa-solid fa-plane"></i></div>
                                </div>
                                <div class="sp-node">
                                    <div class="sp-node__time" data-out-arr-time>—</div>
                                    <div class="sp-node__icon"><i class="fa-solid fa-location-dot"></i></div>
                                    <div class="sp-node__text" data-out-arr-airport>—</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- INBOUND -->
                <section class="sp-leg">
                    <div class="sp-leg__title">Đến <span data-from-city>—</span></div>
                    <div class="sp-leg__panel">
                        <div class="sp-leg__grid">
                            <div class="sp-leg__date">
                                <i class="fa-regular fa-calendar"></i>
                                <span data-in-date>—</span>
                            </div>
                            <div class="sp-leg__timeline">
                                <div class="sp-node">
                                    <div class="sp-node__time" data-in-dep-time>—</div>
                                    <div class="sp-node__icon"><i class="fa-solid fa-location-pin"></i></div>
                                    <div class="sp-node__text" data-in-dep-airport>—</div>
                                </div>
                                <div class="sp-node sp-node--plane">
                                    <div class="sp-node__time">&nbsp;</div>
                                    <div class="sp-node__icon"><i class="fa-solid fa-plane"></i></div>
                                </div>
                                <div class="sp-node">
                                    <div class="sp-node__time" data-in-arr-time>—</div>
                                    <div class="sp-node__icon"><i class="fa-solid fa-location-dot"></i></div>
                                    <div class="sp-node__text" data-in-arr-airport>—</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="sp-modal__footer">
                <button class="sp-btn sp-btn--ghost" type="button">Chia sẻ chuyến đi</button>
                <button id="spBookBtn" class="sp-btn sp-btn--primary" type="button">Đặt ngay với giá</button>
            </div>
        </div>
    </div>



    <div id="footer-container"></div>

    <script src="assets/scripts/search.js"></script>
    <script src="assets/scripts/common.js"></script>
    <script src="assets/scripts/search_translations.js"></script>
    <script src="assets/scripts/search_filter.js"></script>
    
    <script>
        
        // Setup event delegation for modal triggers
        document.addEventListener('click', function(event) {
            if (event.target.matches('.sp-modal-trigger') || event.target.closest('.sp-modal-trigger')) {
                event.preventDefault();
                console.log('Modal trigger clicked via delegation!');
                
                const btn = event.target.matches('.sp-modal-trigger') ? 
                    event.target : event.target.closest('.sp-modal-trigger');
                    
                try {
                    const modal = document.getElementById('spModal');
                    if (!modal) {
                        console.error('Modal not found in DOM!');
                        return;
                    }
                    
                    // Get flight data
                    const out = JSON.parse(btn.getAttribute('data-out') || '{}');
                    const inn = JSON.parse(btn.getAttribute('data-in') || '{}');
                    const tripType = btn.getAttribute('data-trip-type') || 'round-trip';
                    
                    // Store trip type in the modal for later use
                    modal.setAttribute('data-trip-type', tripType);
                    
                    // Mark this button as selected for reference when booking
                    document.querySelectorAll('.sp-modal-trigger').forEach(trigger => {
                        trigger.setAttribute('data-selected', 'false');
                    });
                    btn.setAttribute('data-selected', 'true');
                    
                    // Hiển thị hoặc ẩn phần chuyến về dựa vào loại vé
                    const inboundSection = modal.querySelector('.sp-leg:nth-child(2)');
                    if (inboundSection) {
                        inboundSection.style.display = tripType === 'one-way' ? 'none' : 'block';
                    }
                    
                    // Update modal content directly
                    // Modal element is already defined above
                    const bookBtn = document.getElementById('spBookBtn');
                    
                    // Utility function to format airport name
                    function formatAirport(code) {
                        if (!code) return '—';
                        const airports = {
                            'HAN': 'Hà Nội (HAN)',
                            'SGN': 'Hồ Chí Minh (SGN)',
                            'DAD': 'Đà Nẵng (DAD)',
                            'CXR': 'Nha Trang (CXR)',
                            'DLI': 'Đà Lạt (DLI)',
                            'PQC': 'Phú Quốc (PQC)',
                            'VCA': 'Cần Thơ (VCA)',
                            'VCS': 'Côn Đảo (VCS)',
                            'UIH': 'Quy Nhơn (UIH)',
                            'THD': 'Thanh Hóa (THD)',
                            'VDH': 'Đồng Hới (VDH)',
                            'HUI': 'Huế (HUI)',
                        };
                        return airports[code] || code;
                    }
                    
                    // Helper to set text content
                    function setText(root, sel, val) {
                        const el = root.querySelector(sel);
                        if (el) el.textContent = (val && String(val).trim()) || '—';
                    }
                    
                    // Lấy tên thành phố từ sân bay
                    let outArrCity = formatAirport(out.arrival_airport || '').split('(')[0].trim();
                    let inArrCity = formatAirport(inn.arrival_airport || '').split('(')[0].trim();
                    
                    // Set modal cho chiều đi và về
                    setText(modal, '[data-to-city]', outArrCity || '—');
                    setText(modal, '[data-from-city]', inArrCity || '—');
                    
                    // Outbound
                    setText(modal, '[data-out-date]', out.departure_time ? new Date(out.departure_time).toLocaleDateString('vi-VN') : '—');
                    setText(modal, '[data-out-dep-time]', out.departure_time ? new Date(out.departure_time).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'}) : '—');
                    setText(modal, '[data-out-dep-airport]', formatAirport(out.departure_airport) || '—');
                    setText(modal, '[data-out-arr-time]', out.arrival_time ? new Date(out.arrival_time).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'}) : '—');
                    setText(modal, '[data-out-arr-airport]', formatAirport(out.arrival_airport) || '—');
                    
                    // Inbound
                    setText(modal, '[data-in-date]', inn.departure_time ? new Date(inn.departure_time).toLocaleDateString('vi-VN') : '—');
                    setText(modal, '[data-in-dep-time]', inn.departure_time ? new Date(inn.departure_time).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'}) : '—');
                    setText(modal, '[data-in-dep-airport]', formatAirport(inn.departure_airport) || '—');
                    setText(modal, '[data-in-arr-time]', inn.arrival_time ? new Date(inn.arrival_time).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'}) : '—');
                    setText(modal, '[data-in-arr-airport]', formatAirport(inn.arrival_airport) || '—');
                    
                    // Tính tổng giá từ dữ liệu thực tế với logic phát sinh nếu không có giá
                    let outPrice = Number(out.price) || 0;
                    let inPrice = tripType === 'one-way' ? 0 : Number(inn.price) || 0;
                    
                    // Tính giá cho chuyến đi nếu không có giá
                    if (outPrice === 0 && out.departure_time && out.arrival_time) {
                        const depTime = new Date(out.departure_time);
                        const arrTime = new Date(out.arrival_time);
                        const durationHours = Math.floor((arrTime - depTime) / (1000 * 60 * 60));
                        outPrice = Math.round(500000 + durationHours * 300000);
                    }
                    
                    // Tính giá cho chuyến về nếu là khứ hồi và không có giá
                    if (tripType === 'round-trip' && inPrice === 0 && inn && inn.departure_time && inn.arrival_time) {
                        const depTime = new Date(inn.departure_time);
                        const arrTime = new Date(inn.arrival_time);
                        const durationHours = Math.floor((arrTime - depTime) / (1000 * 60 * 60));
                        inPrice = Math.round(500000 + durationHours * 300000);
                    }
                    
                    // Đảm bảo giá không quá thấp
                    if (outPrice < 500000) outPrice = 500000 + Math.round(Math.random() * 200000);
                    if (tripType === 'round-trip' && inPrice < 500000) inPrice = 500000 + Math.round(Math.random() * 200000);
                    
                    // Đảm bảo giá không quá cao
                    if (outPrice > 2000000) outPrice = 2000000 - Math.round(Math.random() * 200000);
                    if (tripType === 'round-trip' && inPrice > 2000000) inPrice = 2000000 - Math.round(Math.random() * 200000);
                    
                    const totalPrice = tripType === 'one-way' ? outPrice : outPrice + inPrice;
                    if (bookBtn) {
                        bookBtn.textContent = 'Đặt ngay với giá ' + totalPrice.toLocaleString('vi-VN') + ' VND';
                    }
                    
                    // Open modal
                    document.body.classList.add('modal-open');
                    modal.classList.add('is-open');
                    modal.setAttribute('aria-hidden', 'false');
                    console.log('Modal opened via delegation');
                } catch(e) {
                    console.error('Error opening modal:', e);
                }
            }
        });
        
        // Setup close handlers
        document.addEventListener('click', function(event) {
            if (event.target.hasAttribute('data-close') || 
                event.target.classList.contains('sp-modal__backdrop')) {
                
                const modal = document.getElementById('spModal');
                if (modal) {
                    document.body.classList.remove('modal-open');
                    modal.classList.remove('is-open');
                    modal.setAttribute('aria-hidden', 'true');
                    console.log('Modal closed via delegation');
                }
            }
        });
        
        // ESC key to close
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('spModal');
                if (modal && modal.classList.contains('is-open')) {
                    document.body.classList.remove('modal-open');
                    modal.classList.remove('is-open');
                    modal.setAttribute('aria-hidden', 'true');
                    console.log('Modal closed via ESC key');
                }
            }
        });
        
        // Handle booking button click
        document.getElementById('spBookBtn').addEventListener('click', function() {
            // Get currently selected flight data from the modal
            const modal = document.getElementById('spModal');
            const tripType = modal.getAttribute('data-trip-type') || 'round-trip';
            
            // Get flight data from the modal trigger button that was clicked
            const triggerButton = document.querySelector('.sp-modal-trigger[data-selected="true"]');
            if (!triggerButton) {
                console.error('No selected flight found');
                return;
            }
            
            const out = JSON.parse(triggerButton.getAttribute('data-out') || '{}');
            const inn = JSON.parse(triggerButton.getAttribute('data-in') || '{}');
            
            // Get passenger counts from URL
            const searchParams = new URLSearchParams(window.location.search);
            const numAdults = searchParams.get('adults') || 1;
            const numChildren = searchParams.get('children') || 0;
            const numInfants = searchParams.get('infants') || 0;
            
            // Calculate prices (should match the modal calculation)
            let outPrice = Number(out.price) || 0;
            let inPrice = tripType === 'one-way' ? 0 : Number(inn.price) || 0;
            
            // Calculate fare if missing
            if (outPrice === 0 && out.departure_time && out.arrival_time) {
                const depTime = new Date(out.departure_time);
                const arrTime = new Date(out.arrival_time);
                const durationHours = Math.floor((arrTime - depTime) / (1000 * 60 * 60));
                outPrice = Math.round(500000 + durationHours * 300000);
            }
            
            if (tripType === 'round-trip' && inPrice === 0 && inn && inn.departure_time && inn.arrival_time) {
                const depTime = new Date(inn.departure_time);
                const arrTime = new Date(inn.arrival_time);
                const durationHours = Math.floor((arrTime - depTime) / (1000 * 60 * 60));
                inPrice = Math.round(500000 + durationHours * 300000);
            }
            
            // Apply price limits
            if (outPrice < 500000) outPrice = 500000 + Math.round(Math.random() * 200000);
            if (tripType === 'round-trip' && inPrice < 500000) inPrice = 500000 + Math.round(Math.random() * 200000);
            if (outPrice > 2000000) outPrice = 2000000 - Math.round(Math.random() * 200000);
            if (tripType === 'round-trip' && inPrice > 2000000) inPrice = 2000000 - Math.round(Math.random() * 200000);
            
            const totalPrice = tripType === 'one-way' ? outPrice : outPrice + inPrice;
            
            // Build URL parameters
            const params = new URLSearchParams();
            params.append('outbound_id', out.id);
            if (tripType === 'round-trip') {
                params.append('inbound_id', inn.id);
            }
            
            // Add outbound flight details
            params.append('outbound_flight_number', out.flight_number);
            params.append('outbound_departure_airport', out.departure_airport);
            params.append('outbound_arrival_airport', out.arrival_airport);
            params.append('outbound_departure_time', out.departure_time);
            params.append('outbound_arrival_time', out.arrival_time);
            params.append('outbound_price', outPrice);
            
            // Add inbound flight details if round-trip
            if (tripType === 'round-trip' && inn) {
                params.append('inbound_flight_number', inn.flight_number);
                params.append('inbound_departure_airport', inn.departure_airport);
                params.append('inbound_arrival_airport', inn.arrival_airport);
                params.append('inbound_departure_time', inn.departure_time);
                params.append('inbound_arrival_time', inn.arrival_time);
                params.append('inbound_price', inPrice);
            }
            
            // Add search criteria to maintain context
            params.append('trip_type', tripType);
            params.append('adults', numAdults);
            params.append('children', numChildren);
            params.append('infants', numInfants);
            params.append('total_price', totalPrice);
            
            // Navigate to fare selection page
            window.location.href = `/fare?${params.toString()}`;
        });
    </script>


    <script>
        function handleComponentError(componentName) {
            console.error(`Failed to load ${componentName} component`);
        }

        function initializeLanguage() {
            // Get or set language
            let currentLang = localStorage.getItem('preferredLanguage');
            if (!currentLang) {
                currentLang = 'vi';
                localStorage.setItem('preferredLanguage', 'vi');
            }

            document.documentElement.lang = currentLang;

            // Initialize components after a short delay
            setTimeout(() => {
                if (typeof initializeMobileMenu === 'function') {
                    initializeMobileMenu();
                    console.log('Mobile menu initialized');
                }
                if (typeof initializeLanguageSelector === 'function') {
                    initializeLanguageSelector();
                    console.log('Language selector initialized');
                }

                if (typeof initializeSearchFilter === 'function') {
                    initializeSearchFilter();
                    console.log('Search filter initialized');
                }

                // Initialize search translations
                if (typeof initSearchTranslations === 'function') {
                    initSearchTranslations();
                    console.log('Search translations initialized');
                }

                // Apply language to search page
                if (typeof changeSearchLanguage === 'function') {
                    changeSearchLanguage(currentLang);
                    console.log('Search language applied:', currentLang);
                }

                if (typeof updateSelectedLanguage === 'function') {
                    updateSelectedLanguage(currentLang);
                    console.log('Language selector updated:', currentLang);
                }
            }, 200);
        }

        function initializeApp() {
            // Load header
            fetch('components/header.html')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    document.getElementById('header-container').innerHTML = data;
                    console.log('Header loaded successfully');

                    // After header loads, initialize language functionality
                    initializeLanguage();
                })
                .catch(error => {
                    handleComponentError('header');
                    console.error('Error loading header:', error);
                    // Still initialize language even if header fails
                    initializeLanguage();
                });

            // Load footer
            fetch('components/footer.html')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    document.getElementById('footer-container').innerHTML = data;
                    console.log('Footer loaded successfully');
                })
                .catch(error => {
                    handleComponentError('footer');
                    console.error('Error loading footer:', error);
                });
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // Tự động tải dữ liệu chuyến bay khi trang được tải
            setTimeout(function() {
                if (typeof fetchFlights === 'function') {
                    fetchFlights();
                }
            }, 500);
        });
    </script>
</body>

</html>