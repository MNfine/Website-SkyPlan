<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SkyPlane – Search Results</title>
    <link rel="stylesheet" href="assets/styles/search.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="assets/styles/reset.css">
    <link rel="stylesheet" href="assets/styles/index.css">
    <link rel="stylesheet" href="assets/styles/flags.css">
    <link rel="stylesheet" href="assets/styles/header.css">
    <link rel="stylesheet" href="assets/styles/footer.css">
    <link rel="stylesheet" href="assets/styles/loader.css">
</head>

<body class="with-fixed-header with-fixed-footer">
    <div id="header-container"></div>

    <main class="sp-container">
        <aside class="sp-filters" aria-label="Search filters">
            <h2 class="sp-title">Chuyến đi của bạn</h2>

            <form id="spSearchForm">
                <div class="sp-field">
                    <label class="sp-label" data-i18n="search.from">Từ</label>
                    <select id="fromCity" class="sp-input sp-city-dropdown" required></select>
                </div>

                <div class="sp-field">
                    <label class="sp-label" data-i18n="search.to">Đến</label>
                    <select id="toCity" class="sp-input sp-city-dropdown" required></select>
                </div>

                <div class="sp-row sp-field-group">
                    <div class="sp-field">
                        <label for="dep" class="sp-label">Ngày đi</label>
                        <input id="dep" class="sp-input" type="date">
                    </div>
                    <div class="sp-field">
                        <label for="ret" class="sp-label">Ngày về</label>
                        <input id="ret" class="sp-input" type="date">
                    </div>
                </div>

                <!-- Trip Type Selection - moved below dates -->
                <div class="sp-row sp-field-group">
                    <label class="sp-trip-option">
                        <input type="radio" name="tripType" value="round-trip" checked>
                        <span data-i18n="search.roundTrip">Khứ hồi</span>
                    </label>
                    <label class="sp-trip-option">
                        <input type="radio" name="tripType" value="one-way">
                        <span data-i18n="search.oneWay">Một chiều</span>
                    </label>
                </div>

                <button class="sp-btn sp-btn-secondary" type="button" id="searchButton">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    Tìm kiếm
                </button>

                <h3 class="sp-subtitle">Bộ lọc</h3>

                <section class="sp-section" aria-labelledby="budget-heading">
                    <h4 id="budget-heading" class="sp-section-title">Ngân sách</h4>
                    <div class="sp-price-top"><span>0 VND – 5.000.000 VND</span><span>Bất kỳ</span></div>
                    <input id="priceRange" class="sp-range" type="range" max="5000000" step="50000" value="3000000">
                    <div class="sp-price-bottom"><span>0 VND</span><span id="priceOut">3.000.000 VND</span></div>
                </section>


                <section class="sp-section" aria-labelledby="time-heading">
                    <h4 id="time-heading" class="sp-section-title">Giờ bay</h4>
                    <label class="sp-choice"><input type="radio" name="time" checked>5:00 - 11:49</label>
                    <label class="sp-choice"><input type="radio" name="time">12:00 - 17:59</label>
                    <label class="sp-choice"><input type="radio" name="time"> 18:00 - 23:59</label>
                    <label class="sp-choice"><input type="radio" name="time"> 00:00 - 4:59</label>
                </section>


        </aside>

        <section class="sp-results" aria-live="polite" aria-labelledby="results-heading">
            <h2 id="results-heading" class="sr-only">Kết quả tìm kiếm</h2>
            <!-- Results will be injected dynamically -->
        </section>
    </main>

    <div id="spModal" class="sp-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="sp-modal__backdrop" data-close></div>

        <div class="sp-modal__dialog" role="document" aria-labelledby="spModalTitle">
            <div class="sp-modal__header">
                <h2 id="spModalTitle">Flight Details</h2>
                <button type="button" class="sp-modal__close" aria-label="Close" data-close>&times;</button>
            </div>

            <div class="sp-modal__content">
                <!-- OUTBOUND -->
                <section class="sp-leg" aria-labelledby="outbound-heading">
                    <h3 id="outbound-heading" class="sr-only">Chiều đi</h3>
                    <div class="sp-leg__title"><span data-i18n="legTo">To</span> <span data-to-city>—</span></div>
                    <div class="sp-leg__panel">
                        <div class="sp-leg__grid">
                            <div class="sp-leg__date">
                                <i class="fa-regular fa-calendar"></i>
                                <span data-out-date>—</span>
                            </div>
                            <div class="sp-leg__timeline">
                                <div class="sp-node">
                                    <div class="sp-node__time" data-out-dep-time>—</div>
                                    <div class="sp-node__icon"><i class="fa-solid fa-location-pin"></i></div>
                                    <div class="sp-node__text" data-out-dep-airport>—</div>
                                </div>
                                <div class="sp-node sp-node--plane">
                                    <div class="sp-node__time">&nbsp;</div>
                                    <div class="sp-node__icon"><i class="fa-solid fa-plane"></i></div>
                                </div>
                                <div class="sp-node">
                                    <div class="sp-node__time" data-out-arr-time>—</div>
                                    <div class="sp-node__icon"><i class="fa-solid fa-location-dot"></i></div>
                                    <div class="sp-node__text" data-out-arr-airport>—</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- INBOUND -->
                <section class="sp-leg" aria-labelledby="inbound-heading">
                    <h3 id="inbound-heading" class="sr-only">Chiều về</h3>
                    <div class="sp-leg__title">To <span data-from-city>—</span></div>
                    <div class="sp-leg__panel">
                        <div class="sp-leg__grid">
                            <div class="sp-leg__date">
                                <i class="fa-regular fa-calendar"></i>
                                <span data-in-date>—</span>
                            </div>
                            <div class="sp-leg__timeline">
                                <div class="sp-node">
                                    <div class="sp-node__time" data-in-dep-time>—</div>
                                    <div class="sp-node__icon"><i class="fa-solid fa-location-pin"></i></div>
                                    <div class="sp-node__text" data-in-dep-airport>—</div>
                                </div>
                                <div class="sp-node sp-node--plane">
                                    <div class="sp-node__time">&nbsp;</div>
                                    <div class="sp-node__icon"><i class="fa-solid fa-plane"></i></div>
                                </div>
                                <div class="sp-node">
                                    <div class="sp-node__time" data-in-arr-time>—</div>
                                    <div class="sp-node__icon"><i class="fa-solid fa-location-dot"></i></div>
                                    <div class="sp-node__text" data-in-arr-airport>—</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

            </div>

            <div class="sp-modal__footer">
                <button class="sp-btn sp-btn--ghost" type="button">Chia sẻ chuyến đi</button>
                <button id="spBookBtn" class="sp-btn sp-btn--primary" type="button">Đặt ngay với giá</button>
            </div>
        </div>
    </div>



    <div id="footer-container"></div>

    <script src="assets/scripts/search.js"></script>
    <script src="assets/scripts/common.js"></script>
    <script src="assets/scripts/search_translations.js"></script>
    <script src="assets/scripts/search_filter.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loadComponent = async (id, file) => {
                const container = document.getElementById(id);
                if (container) {
                    try {
                        const html = await fetch(file).then(r => r.text());
                        container.innerHTML = html;
                    } catch (e) {
                        console.error(`Không load được ${file}:`, e);
                    }
                }
            };
            await loadComponent('header-container', 'components/header.html');
            await loadComponent('footer-container', 'components/footer.html');
        });
    </script>

    <script>
        (function () {
            function $(sel, ctx) {
                return (ctx || document).querySelector(sel);
            }

            function $all(sel, ctx) {
                return Array.prototype.slice.call((ctx || document).querySelectorAll(sel));
            }

            function text(el) {
                return el && el.textContent ? el.textContent.trim() : '';
            }

            function setText(root, sel, val) {
                var el = root.querySelector(sel);
                if (el) el.textContent = (val && String(val).trim()) || '—';
            }

            function initSlider() {
                var slider = document.getElementById('priceRange');
                var out = document.getElementById('priceOut');
                if (!slider || !out) return;

                function fmt(v) {
                    return Number(v).toLocaleString('vi-VN') + ' VND';
                }

                function paintRange() {
                    var min = Number(slider.min || 0);
                    var max = Number(slider.max || 100);
                    var val = Number(slider.value || 0);
                    var pct = ((val - min) / (max - min)) * 100;

                    try {
                        slider.style.setProperty('--sp-range-pct', pct + '%');
                    } catch (e) { }

                    slider.style.background = 'linear-gradient(to right, var(--sp-primary) ' + pct + '%, #e5e7eb ' + pct + '%)';
                    out.textContent = fmt(val);
                }
                paintRange();
                slider.addEventListener('input', paintRange);
                slider.addEventListener('change', paintRange);
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function () {
                    initSlider();
                });
            } else {
                initSlider();
            }
        })();
    </script>


    <script>
        function handleComponentError(componentName) {
            console.error(`Failed to load ${componentName} component`);
        }

        function initializeLanguage() {
            // Get or set language
            let currentLang = localStorage.getItem('preferredLanguage');
            if (!currentLang) {
                currentLang = 'vi';
                localStorage.setItem('preferredLanguage', 'vi');
            }

            document.documentElement.lang = currentLang;

            // Initialize components after a short delay
            setTimeout(() => {
                if (typeof initializeMobileMenu === 'function') {
                    initializeMobileMenu();
                    console.log('Mobile menu initialized');
                }
                if (typeof initializeLanguageSelector === 'function') {
                    initializeLanguageSelector();
                    console.log('Language selector initialized');
                }

                if (typeof initializeSearchFilter === 'function') {
                    initializeSearchFilter();
                    console.log('Search filter initialized');
                }

                // Initialize search translations
                if (typeof initSearchTranslations === 'function') {
                    initSearchTranslations();
                    console.log('Search translations initialized');
                }

                // Apply language to search page
                if (typeof changeSearchLanguage === 'function') {
                    changeSearchLanguage(currentLang);
                    console.log('Search language applied:', currentLang);
                }

                if (typeof updateSelectedLanguage === 'function') {
                    updateSelectedLanguage(currentLang);
                    console.log('Language selector updated:', currentLang);
                }
                // changeSearchLanguage already fires languageChanged; avoid re-dispatching here.
            }, 200);
        }

        function initializeApp() {
            // Load header
            fetch('components/header.html')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    document.getElementById('header-container').innerHTML = data;
                    console.log('Header loaded successfully');

                    // After header loads, initialize language functionality
                    initializeLanguage();
                })
                .catch(error => {
                    handleComponentError('header');
                    console.error('Error loading header:', error);
                    // Still initialize language even if header fails
                    initializeLanguage();
                });

            // Load footer
            fetch('components/footer.html')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    document.getElementById('footer-container').innerHTML = data;
                    console.log('Footer loaded successfully');
                })
                .catch(error => {
                    handleComponentError('footer');
                    console.error('Error loading footer:', error);
                });
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
            
            // Tự động tải dữ liệu chuyến bay khi trang được tải
            setTimeout(function() {
                if (typeof fetchFlights === 'function') {
                    fetchFlights();
                }
            }, 500);
        });
    </script>

    <script>
        (function () {
            // Lấy ngôn ngữ hiện tại
            function getLang() {
                return localStorage.getItem('preferredLanguage') || 'vi';
            }

            // Tạo dropdown cho phần "From" và "To"
            const citySelects = document.querySelectorAll('.sp-city-dropdown');

            citySelects.forEach(select => {
                const lang = getLang();
                const cities = window.SKYPLAN_CITY_TRANSLATIONS[lang];
                select.innerHTML = ''; // xoá sạch option cũ

                // Tạo option mặc định
                const defOpt = document.createElement('option');
                defOpt.textContent = lang === 'vi' ? 'Chọn thành phố' : 'Select city';
                defOpt.value = '';
                defOpt.disabled = true;
                defOpt.selected = true;
                select.appendChild(defOpt);

                // Đổ danh sách thành phố
                for (const code in cities) {
                    const opt = document.createElement('option');
                    opt.value = code; // ví dụ: HaNoi
                    opt.textContent = cities[code]; // ví dụ: Hà Nội
                    select.appendChild(opt);
                }
            });

            // Khi đổi ngôn ngữ thì dropdown tự cập nhật
            document.addEventListener('languageChanged', (e) => {
                const newLang = e.detail.lang;
                citySelects.forEach(select => {
                    const currentValue = select.value;
                    const cities = window.SKYPLAN_CITY_TRANSLATIONS[newLang];
                    select.innerHTML = '';
                    const defOpt = document.createElement('option');
                    defOpt.textContent = newLang === 'vi' ? 'Chọn thành phố' : 'Select city';
                    defOpt.value = '';
                    defOpt.disabled = true;
                    select.appendChild(defOpt);

                    for (const code in cities) {
                        const opt = document.createElement('option');
                        opt.value = code;
                        opt.textContent = cities[code];
                        if (code === currentValue) opt.selected = true;
                        select.appendChild(opt);
                    }
                });
            });


        })();
    </script>

    <script>
        document.getElementById('spSearchForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const lang = localStorage.getItem('preferredLanguage') || 'vi';
            const dict = (window.SKYPLAN_CITY_TRANSLATIONS && window.SKYPLAN_CITY_TRANSLATIONS[lang]) || {};

            const fromCode = document.getElementById('fromCity').value;
            const toCode = document.getElementById('toCity').value;
            const fromName = dict[fromCode];
            const toName = dict[toCode];

            // Always submit ISO (YYYY-MM-DD), use dataset when in text display mode
            const depEl = document.getElementById('dep');
            const retEl = document.getElementById('ret');
            const depart = (depEl && (depEl.dataset.isoValue || depEl.value)) || '';
            const ret = (retEl && (retEl.dataset.isoValue || retEl.value)) || '';

            const data = { fromCode, fromName, toCode, toName, depart, ret };
            sessionStorage.setItem('skyplan:lastSearch', JSON.stringify(data));
            
            // Show loader trước khi redirect
            if (window.Loader) {
                window.Loader.show();
                setTimeout(function() {
                    location.href = `search.html?from=${fromCode}&to=${toCode}&departure=${depart}&return=${ret}`;
                }, 1500);
            } else {
                location.href = `search.html?from=${fromCode}&to=${toCode}&departure=${depart}&return=${ret}`;
            }
        });
    </script>



    <script>
        (function () {
            const KEY = 'skyplan:lastSearch';

            function getLang() {
                return localStorage.getItem('preferredLanguage') || document.documentElement.lang || 'vi';
            }

            function formatDate(dateStr, lang) {
                if (!dateStr) return '';
                const [year, month, day] = dateStr.split('-');
                return lang === 'vi' ? `${day}/${month}/${year}` : `${month}/${day}/${year}`;
            }

            function readState() {
                const p = new URLSearchParams(location.search);
                let state = {
                    from: p.get('from') || '',
                    to: p.get('to') || '',
                    depart: p.get('departure') || '',
                    ret: p.get('return') || '',
                };
                if ((!state.from || !state.to) && sessionStorage.getItem(KEY)) {
                    try {
                        const s = JSON.parse(sessionStorage.getItem(KEY));
                        state.from = state.from || s.fromCode || '';
                        state.to = state.to || s.toCode || '';
                        state.depart = state.depart || s.depart || '';
                        state.ret = state.ret || s.ret || '';
                    } catch { }
                }
                return state;
            }

            function ensureOption(select, code, label) {
                if (!select || !code) return;
                const found = Array.from(select.options).some(o => o.value === code);
                if (!found) {
                    const opt = document.createElement('option');
                    opt.value = code;
                    opt.textContent = label || code;
                    select.appendChild(opt);
                }
                select.value = code;
            }

            function applyState(state) {
                const lang = getLang();

                const fromSel = document.getElementById('fromCity');
                const toSel = document.getElementById('toCity');
                const depart = document.getElementById('dep');
                const ret = document.getElementById('ret');

                if (fromSel) fromSel.value = state.from || '';
                if (toSel) toSel.value = state.to || '';

                // Normalize incoming dates to ISO (YYYY-MM-DD)
                const isISO = (s) => /^\d{4}-\d{2}-\d{2}$/.test(s || '');
                const isDDMM = (s) => /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s || '');
                const isMMDD = (s) => /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s || '');
                const parseToISO = (s) => {
                    if (!s) return '';
                    if (isISO(s)) return s;
                    const h = window.dateFormatHandler;
                    // Try DD/MM/YYYY first (VI), then MM/DD/YYYY (EN)
                    let iso = h && h.parseDDMMToISO ? h.parseDDMMToISO(s) : '';
                    if (!iso && h && h.parseMMDDToISO) iso = h.parseMMDDToISO(s);
                    return iso || '';
                };

                // Initialize date handler first, but skip if we have URL params to preserve
                const hasDateParams = state.depart || state.ret;
                
                if (window.dateFormatHandler && !hasDateParams) {
                    // Only call ensureTodayAndMins if we don't have URL params
                    window.dateFormatHandler.ensureTodayAndMins();
                } else if (window.dateFormatHandler) {
                    // Just set minimum dates without overriding values
                    const today = new Date().toISOString().slice(0, 10);
                    if (depart) depart.min = today;
                    if (ret) ret.min = depart ? (depart.value || today) : today;
                }

                // Apply URL parameter values
                if (depart && state.depart) {
                    const depISO = parseToISO(state.depart);
                    if (depISO) {
                        depart.dataset.isoValue = depISO;
                        depart.value = depISO;
                        if (ret) ret.min = depISO; // Update return minimum
                    }
                }

                if (ret && state.ret) {
                    const retISO = parseToISO(state.ret);
                    if (retISO) {
                        ret.dataset.isoValue = retISO;
                        ret.value = retISO;
                    }
                }

                // Finally update UI formatting and constraints
                if (window.dateFormatHandler) {
                    window.dateFormatHandler.updateDateInputsByLang(lang);
                    if (!hasDateParams) {
                        window.dateFormatHandler.enforceReturnAfterDeparture();
                    }
                }
            }

            function readState() {
                const p = new URLSearchParams(location.search);
                return {
                    from: p.get('from') || '',
                    to: p.get('to') || '',
                    depart: p.get('departure') || '',
                    ret: p.get('return') || '',
                };
            }

            document.addEventListener('DOMContentLoaded', () => {
                const state = readState();
                applyState(state);
            });
        })();
    </script>

    <script>
        (function () {
            // Bảng song ngữ theo mã IATA (bổ sung thêm nếu cần)
            const CITY_BY_CODE = {
                HAN: {
                    vi: 'Hà Nội',
                    en: 'Ha Noi'
                },
                SGN: {
                    vi: 'Hồ Chí Minh',
                    en: 'Ho Chi Minh'
                },
                DAD: {
                    vi: 'Đà Nẵng',
                    en: 'Da Nang'
                },
                PQC: {
                    vi: 'Phú Quốc',
                    en: 'Phu Quoc'
                },
                HPH: {
                    vi: 'Hải Phòng',
                    en: 'Hai Phong'
                },
                HUI: {
                    vi: 'Huế',
                    en: 'Hue'
                },
                DLI: {
                    vi: 'Đà Lạt',
                    en: 'Da Lat'
                },
                VCA: {
                    vi: 'Cần Thơ',
                    en: 'Can Tho'
                }
            };

            function getLang() {
                return localStorage.getItem('preferredLanguage') || document.documentElement.lang || 'vi';
            }

            // Tự bắt mã IATA trong text "(XXX)" nếu chưa có data-iata
            function ensureIata(el) {
                if (el.dataset.iata) return el.dataset.iata;
                const m = el.textContent.trim().match(/\(([A-Z]{3})\)\s*$/);
                if (!m) return null;
                el.dataset.iata = m[1];
                return m[1];
            }

            // Cập nhật tên địa điểm theo ngôn ngữ cho cả card & modal
            function renderAirportLabels(lang) {
                const TARGETS = [
                    '.sp-card .sp-meta', // các card kết quả
                    '.sp-modal [data-out-dep-airport]',
                    '.sp-modal [data-out-arr-airport]',
                    '.sp-modal [data-in-dep-airport]',
                    '.sp-modal [data-in-arr-airport]'
                ].join(',');
                document.querySelectorAll(TARGETS).forEach(el => {
                    const code = ensureIata(el);
                    if (!code) return;
                    const row = CITY_BY_CODE[code];
                    if (row && row[lang]) el.textContent = `${row[lang]} (${code})`;
                });
            }

            // Lúc trang load
            document.addEventListener('DOMContentLoaded', () => {
                renderAirportLabels(getLang());
            });

            // Khi header đổi ngôn ngữ
            document.addEventListener('languageChanged', function (e) {
                // dùng cú pháp "an toàn" không optional chaining để khỏi lỗi
                var lang = (e && e.detail && e.detail.lang) || getLang();
                renderAirportLabels(lang);
            });

            // Export nhẹ để gọi sau parseCard
            window.__spRenderAirports = renderAirportLabels;
            window.__spGetLang = getLang;
        })();
    </script>

    <script>
        // hàm phụ an toàn lấy lang
        function getLangSafe(e) {
            return (e && e.detail && e.detail.lang) || localStorage.getItem('preferredLanguage') || 'vi';
        }

        // ====== Lắng nghe đổi ngôn ngữ từ header ======
        document.addEventListener('languageChanged', function (e) {
            const lang = getLangSafe(e);

            // 1) Text tĩnh dùng i18n được xử lý bởi nơi phát sự kiện (header/common),
            // tránh gọi lại changeSearchLanguage/initSearchTranslations để không tạo vòng lặp.

            // 2) Relabel dropdown From/To (không thay value đang chọn)
            (function relabelSelects() {
                const dict = (window.SKYPLAN_CITY_TRANSLATIONS && window.SKYPLAN_CITY_TRANSLATIONS[lang]) || {};
                ['fromCity', 'toCity'].forEach(id => {
                    const sel = document.getElementById(id);
                    if (!sel) return;
                    Array.from(sel.options).forEach(opt => {
                        if (dict[opt.value]) opt.textContent = dict[opt.value];
                    });
                });
            })();

            // 3) Đổi city labels trong **card kết quả + modal**
            if (typeof window.__spRenderAirports === 'function') window.__spRenderAirports(lang);

            // 4) Thông điệp "không có chuyến bay" (nếu có phần tử này)
            const empty = document.querySelector('.sp-empty, [data-empty]');
            if (empty) empty.textContent = (lang === 'vi') ?
                'Không có chuyến bay phù hợp với bộ lọc.' :
                'No flights match your filters.';

            // 5) Nút/CTA trong modal (nếu đang mở)
            if (window.MODAL_I18N && window.MODAL_I18N[lang]) {
                const btn = document.getElementById('spBookBtn');
                const storedPrice = btn && btn.dataset ? (btn.dataset.price || '') : '';
                if (btn) btn.textContent = window.MODAL_I18N[lang].bookPrefix + storedPrice;
                const titleEl = document.getElementById('spModalTitle');
                if (titleEl) titleEl.textContent = window.MODAL_I18N[lang].title;
            }
        });

        // ====== Gọi một lần khi trang vừa load (đồng bộ ngôn ngữ hiện tại)
        // Sự kiện languageChanged đã được phát từ changeSearchLanguage trong initializeLanguage/header; tránh phát lặp.
    </script>

    <!-- Date format handling moved to global date_format_handler.js -->
    <script src="assets/scripts/date_format_handler.js"></script>

    <script>
    // Render dynamic result cards based on URL params (from, to, departure, return)
        (function() {
            const CITY_IATA = {
                HaNoi: 'HAN', HoChiMinh: 'SGN', DaNang: 'DAD', PhuQuoc: 'PQC',
                HaiPhong: 'HPH', Hue: 'HUI', DaLat: 'DLI', CanTho: 'VCA',
                KhanhHoa: 'CXR', LamDong: 'DLI', NgheAn: 'VII', QuangNinh: 'VDO', QuangTri: 'VDH',
                AnGiang: 'VKG', DienBien: 'DIN', GiaLai: 'PXU', SonLa: 'SQH', ThanhHoa: 'THD'
            };
            const CITY_LABELS = window.SKYPLAN_CITY_TRANSLATIONS || { vi: {}, en: {} };
            const getLang = () => localStorage.getItem('preferredLanguage') || document.documentElement.lang || 'vi';

            const fmtDate = (iso) => {
                const h = window.dateFormatHandler;
                const lang = getLang();
                if (h && h.formatDate) return h.formatDate(iso, lang);
                if (!iso) return '';
                const [y,m,d] = iso.split('-');
                return lang === 'vi' ? `${d}/${m}/${y}` : `${m}/${d}/${y}`;
            };

            function readState() {
                const p = new URLSearchParams(location.search);
                return {
                    from: p.get('from') || 'HaNoi',
                    to: p.get('to') || 'HoChiMinh',
                    depart: p.get('departure') || '',
                    ret: p.get('return') || ''
                };
            }

            function generateFlights(state) {
                const seeds = ['06:00','07:30','09:00','11:30','13:00','14:30','16:00','18:00','20:00','22:00'];
                const pick = (n) => seeds.slice(0, Math.min(6, Math.max(3, n)));
                const dateNum = Number((state.depart || '').replace(/\D/g,'')) || 5;
                const outTimes = pick((dateNum % 6) + 3);
                const addMin = (hhmm, add) => {
                    const [h,m] = hhmm.split(':').map(Number);
                    const total = h*60 + m + add;
                    const hh = String(Math.floor(total/60)%24).padStart(2,'0');
                    const mm = String(total%60).padStart(2,'0');
                    return `${hh}:${mm}`;
                };
                return outTimes.map((t, idx) => {
                    const dur1 = 125 + (idx%3)*5;
                    const arr1 = addMin(t, dur1);
                    const retBase = addMin(t, 60 + (idx%2)*30);
                    const dur2 = 120 + (idx%4)*10;
                    const arr2 = addMin(retBase, dur2);
                    const price = 1200000 + idx*150000;
                    return { outDep: t, outArr: arr1, outDur: dur1, inDep: retBase, inArr: arr2, inDur: dur2, price };
                });
            }

            function labelFor(code, lang) {
                const dict = CITY_LABELS[lang] || CITY_LABELS.vi || {};
                return dict[code] || code;
            }

            // Format airport with city name and airport name
            function formatAirport(cityCode, lang) {
                // Use the same logic as in search.js
                const cityDict = CITY_LABELS[lang] || CITY_LABELS.vi || {};
                const cityName = cityDict[cityCode] || cityCode;
                
                // Airport names mapping
                const AIRPORTS = {
                    'hanoi': { vi: 'Sân bay Nội Bài', en: 'Noi Bai Airport' },
                    'ho-chi-minh': { vi: 'Sân bay Tân Sơn Nhất', en: 'Tan Son Nhat Airport' },
                    'da-nang': { vi: 'Sân bay Đà Nẵng', en: 'Da Nang Airport' },
                    'hai-phong': { vi: 'Sân bay Cát Bi', en: 'Cat Bi Airport' },
                    'hue': { vi: 'Sân bay Phú Bài', en: 'Phu Bai Airport' },
                    'nha-trang': { vi: 'Sân bay Cam Ranh', en: 'Cam Ranh Airport' },
                    'da-lat': { vi: 'Sân bay Liên Khương', en: 'Lien Khuong Airport' },
                    'phu-quoc': { vi: 'Sân bay Phú Quốc', en: 'Phu Quoc Airport' },
                    'can-tho': { vi: 'Sân bay Cần Thơ', en: 'Can Tho Airport' },
                    'quy-nhon': { vi: 'Sân bay Phù Cát', en: 'Phu Cat Airport' }
                };
                
                const airportInfo = AIRPORTS[cityCode];
                const airportName = airportInfo ? (airportInfo[lang] || airportInfo.vi) : '';
                
                if (airportName) {
                    return `${cityName} - ${airportName}`;
                }
                return cityName;
            }

            function ensureModalHandlers() {
                const modal = document.getElementById('spModal');
                if (!modal || modal.dataset.closeBound === '1') return;
                modal.addEventListener('click', function(e){
                    if (e.target && e.target.getAttribute('data-close') !== null) {
                        modal.classList.remove('is-open');
                        modal.setAttribute('aria-hidden','true');
                    }
                });
                document.addEventListener('keydown', function(e){
                    if (e.key === 'Escape' && modal.classList.contains('is-open')) {
                        modal.classList.remove('is-open');
                        modal.setAttribute('aria-hidden','true');
                    }
                });
                // Navigate to fare.html when clicking book button
                const bookBtn = document.getElementById('spBookBtn');
                if (bookBtn && !bookBtn.dataset.navBound) {
                    bookBtn.addEventListener('click', function(){
                        try {
                            // Build a persistent selection object from current modal contents
                            const state = readState();
                            const lang = getLang();
                            const CITY_LABELS = window.SKYPLAN_CITY_TRANSLATIONS || { vi: {}, en: {} };
                            const fromName = (CITY_LABELS[lang] && CITY_LABELS[lang][state.from]) || state.from;
                            const toName = (CITY_LABELS[lang] && CITY_LABELS[lang][state.to]) || state.to;
                            const CITY_IATA = {
                                HaNoi: 'HAN', HoChiMinh: 'SGN', DaNang: 'DAD', PhuQuoc: 'PQC',
                                HaiPhong: 'HPH', Hue: 'HUI', DaLat: 'DLI', CanTho: 'VCA',
                                KhanhHoa: 'CXR', LamDong: 'DLI', NgheAn: 'VII', QuangNinh: 'VDO', QuangTri: 'VDH',
                                AnGiang: 'VKG', DienBien: 'DIN', GiaLai: 'PXU', SonLa: 'SQH', ThanhHoa: 'THD'
                            };
                            const fromIATA = CITY_IATA[state.from] || 'XXX';
                            const toIATA = CITY_IATA[state.to] || 'YYY';

                            const outDep = (modal.querySelector('[data-out-dep-time]')?.textContent || '').trim();
                            const outArr = (modal.querySelector('[data-out-arr-time]')?.textContent || '').trim();
                            const inDep = (modal.querySelector('[data-in-dep-time]')?.textContent || '').trim();
                            const inArr = (modal.querySelector('[data-in-arr-time]')?.textContent || '').trim();

                            const parseMin = (s) => { const m = /^([0-2]?\d):([0-5]\d)$/.exec(String(s)); return m ? (parseInt(m[1],10)*60 + parseInt(m[2],10)) : null; };
                            const diffMin = (a,b) => { const A=parseMin(a), B=parseMin(b); if (A==null||B==null) return null; let d=B-A; if (d<0) d+=1440; return d; };

                            const priceLabel = (bookBtn.dataset && bookBtn.dataset.price) ? bookBtn.dataset.price : '';
                            const priceVND = priceLabel ? Number(priceLabel.replace(/[^0-9]/g,''))||0 : 0;

                            const trip = {
                                fromCode: state.from,
                                toCode: state.to,
                                fromIATA,
                                toIATA,
                                fromName,
                                toName,
                                departDateISO: state.depart || '',
                                returnDateISO: state.ret || '',
                                priceLabel: priceLabel || '',
                                priceVND,
                                segments: [
                                    { direction: 'outbound', departTime: outDep, arriveTime: outArr, departIATA: fromIATA, arriveIATA: toIATA, durationMin: diffMin(outDep,outArr) },
                                    { direction: 'inbound', departTime: inDep, arriveTime: inArr, departIATA: toIATA, arriveIATA: fromIATA, durationMin: diffMin(inDep,inArr) }
                                ]
                            };
                            try { localStorage.setItem('skyplan_trip_selection', JSON.stringify(trip)); } catch(_) {}
                            // Provide simple route hints for other pages
                            try {
                                localStorage.setItem('route_from', state.from || '');
                                localStorage.setItem('route_to', state.to || '');
                            } catch(_) {}
                        } catch(_) {}
                        
                        // Đóng modal trước
                        modal.classList.remove('is-open');
                        modal.setAttribute('aria-hidden', 'true');
                        
                        // Show loader sau khi đóng modal
                        if (window.Loader) {
                            window.Loader.show();
                            setTimeout(function() {
                                window.location.href = 'fare.html';
                            }, 1500);
                        } else {
                            window.location.href = 'fare.html';
                        }
                    });
                    bookBtn.dataset.navBound = '1';
                }
                modal.dataset.closeBound = '1';
            }

            function renderResults() {
                const state = readState();
                const lang = getLang();
                const results = document.querySelector('.sp-results');
                if (!results) return;
                const fromIATA = CITY_IATA[state.from] || 'XXX';
                const toIATA = CITY_IATA[state.to] || 'YYY';
                const fromName = formatAirport(state.from, lang);
                const toName = formatAirport(state.to, lang);

                const flights = generateFlights(state);
                const dict = (window.searchTranslations && (window.searchTranslations[lang] || window.searchTranslations.vi)) || {};
                const nonstopLbl = dict.nonstop || (lang === 'vi' ? 'Bay thẳng' : 'Nonstop');
                const selectFlightLbl = dict.selectFlight || (lang === 'vi' ? 'Chọn chuyến bay' : 'Select flight');
                const outDateLabel = `${fmtDate(state.depart)} ${dict.dotDeparture || (lang==='vi'?'· Khởi hành':'· Departure')}`;
                const inDateLabel = `${fmtDate(state.ret || state.depart)} ${dict.dotReturn || (lang==='vi'?'· Về':'· Return')}`;
                const durTxt = (min) => `${Math.floor(min/60)}h${String(min%60).padStart(2,'0')}m`;

                const cards = flights.map((f, i) => `
                    <article class=\"sp-card\" aria-labelledby=\"card${i+1}-heading\">\n                        <h3 id=\"card${i+1}-heading\" class=\"sr-only\">${fromName} → ${toName} ${f.outDep} / ${toName} → ${fromName} ${f.inDep}</h3>\n                        <div class=\"sp-card-body\">\n                            <div class=\"sp-date\">${outDateLabel}</div>\n                            <div class=\"sp-itinerary\">\n                                <div>\n                                    <div class=\"sp-time\">${f.outDep}</div>\n                                    <div class=\"sp-meta\">${fromName} (${fromIATA})</div>\n                                </div>\n                                <div class=\"sp-mid\">\n                                    <i class=\"fa-solid fa-plane sp-plane\"></i>\n                                    <span class=\"sp-duration\">${durTxt(f.outDur)}<br>${nonstopLbl}</span>\n                                </div>\n                                <div>\n                                    <div class=\"sp-time\">${f.outArr}</div>\n                                    <div class=\"sp-meta\">${toName} (${toIATA})</div>\n                                </div>\n                            </div>\n                            <hr class=\"sp-divider\">\n                            <div class=\"sp-date\">${inDateLabel}</div>\n                            <div class=\"sp-itinerary\">\n                                <div>\n                                    <div class=\"sp-time\">${f.inDep}</div>\n                                    <div class=\"sp-meta\">${toName} (${toIATA})</div>\n                                </div>\n                                <div class=\"sp-mid\">\n                                    <i class=\"fa-solid fa-plane sp-plane\"></i>\n                                    <span class=\"sp-duration\">${durTxt(f.inDur)}<br>${nonstopLbl}</span>\n                                </div>\n                                <div>\n                                    <div class=\"sp-time\">${f.inArr}</div>\n                                    <div class=\"sp-meta\">${fromName} (${fromIATA})</div>\n                                </div>\n                            </div>\n                        </div>\n                        <aside class=\"sp-card-aside\">\n                            <div class=\"sp-price\">${(f.price).toLocaleString('vi-VN')} VND</div>\n                            <button class=\"sp-btn sp-btn-block\">${selectFlightLbl}</button>\n                        </aside>\n                    </article>`).join('');

                results.innerHTML = cards;
                // Override all card prices with requested fixed amount
                document.querySelectorAll('.sp-card .sp-price').forEach(function(el){
                    el.textContent = '2.374.000 VND';
                });

                // Refresh filters
                setTimeout(() => {
                    const slider = document.getElementById('priceRange');
                    if (slider) slider.dispatchEvent(new Event('input', { bubbles: true }));
                }, 0);

                // Basic modal binding for new cards
                document.querySelectorAll('.sp-card .sp-btn.sp-btn-block').forEach(btn => {
                    if (btn.dataset.bound === '1') return;
                    btn.addEventListener('click', function() {
                        const card = btn.closest('.sp-card');
                        const modal = document.getElementById('spModal');
                        const bookBtn = document.getElementById('spBookBtn');
                        if (!card || !modal || !bookBtn) return;
                        const setText = (root, sel, val) => { const el = root.querySelector(sel); if (el) el.textContent = val; };
                        setText(modal, '[data-to-city]', toName);
                        setText(modal, '[data-from-city]', fromName);
                        setText(modal, '[data-out-date]', fmtDate(readState().depart));
                        setText(modal, '[data-in-date]', fmtDate(readState().ret || readState().depart));
                        const times = card.querySelectorAll('.sp-time');
                        setText(modal, '[data-out-dep-time]', times[0]?.textContent || '');
                        setText(modal, '[data-out-arr-time]', times[1]?.textContent || '');
                        setText(modal, '[data-in-dep-time]', times[2]?.textContent || '');
                        setText(modal, '[data-in-arr-time]', times[3]?.textContent || '');
                        const currentLang = getLang();
                        const currentFromName = formatAirport(readState().from, currentLang);
                        const currentToName = formatAirport(readState().to, currentLang);
                        setText(modal, '[data-out-dep-airport]', `${currentFromName.split(' - ')[0]} (${fromIATA})`);
                        setText(modal, '[data-out-arr-airport]', `${currentToName.split(' - ')[0]} (${toIATA})`);
                        setText(modal, '[data-in-dep-airport]', `${currentToName.split(' - ')[0]} (${toIATA})`);
                        setText(modal, '[data-in-arr-airport]', `${currentFromName.split(' - ')[0]} (${fromIATA})`);
                        const price = card.querySelector('.sp-price')?.textContent.trim() || '';
                        const langNow = getLang();
                        const lbl = (window.MODAL_I18N && window.MODAL_I18N[langNow]) ? window.MODAL_I18N[langNow].bookPrefix : (langNow==='vi'?'Đặt ngay với giá ':'Book now for ');
                        bookBtn.textContent = lbl + price;
                        if (bookBtn && bookBtn.dataset) bookBtn.dataset.price = price;
                        // Localize modal title if dictionary available
                        const titleEl = modal.querySelector('#spModalTitle');
                        if (titleEl && window.MODAL_I18N && window.MODAL_I18N[langNow]) titleEl.textContent = window.MODAL_I18N[langNow].title;
                        // Ensure airport labels use current language inside modal
                        if (typeof window.__spRenderAirports === 'function') window.__spRenderAirports(langNow);
                        modal.classList.add('is-open');
                        modal.setAttribute('aria-hidden', 'false');
                    });
                    btn.dataset.bound = '1';
                });
                ensureModalHandlers();
            }

            // Render on load only - don't re-render on language change to preserve current flight data
            document.addEventListener('DOMContentLoaded', function(){ ensureModalHandlers(); renderResults(); });
        })();
    </script>

    <!-- Loader component (JS) -->
    <script src="assets/scripts/loader.js"></script>
    <script>
        // Import loader HTML vào DOM càng sớm càng tốt
        fetch('components/loader.html').then(r => r.text()).then(html => {
            document.body.insertAdjacentHTML('afterbegin', html);
            // Show loader ngay khi vừa insert vào DOM (cho F5/reload)
            if (window.Loader) {
                window.Loader.show();
                document.body.style.overflow = 'hidden';
            }
        });
        
        // Ẩn loader khi tất cả resources đã load xong (window.load)
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (window.Loader) {
                    window.Loader.hide();
                    document.body.style.overflow = '';
                }
            }, 500); // Delay 500ms để smooth
        });
    </script>

</body>

</html>