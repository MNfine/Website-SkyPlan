<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="confirmationTitle">SkyPlan - Xác nhận thanh toán</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/styles/reset.css">
  <link rel="stylesheet" href="assets/styles/index.css">
  <link rel="stylesheet" href="assets/styles/header.css">
  <link rel="stylesheet" href="assets/styles/flags.css">
  <link rel="stylesheet" href="assets/styles/footer.css">
  <link rel="stylesheet" href="assets/styles/confirmation.css">
  <link rel="stylesheet" href="assets/styles/loader.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="assets/scripts/auth-utils.js"></script>
  <script src="assets/scripts/common.js"></script>
  <script src="assets/scripts/confirmation_translations.js"></script>
</head>
<body>
  <div id="header-container"></div>
  <div class="confirmation-container">
    <div class="confirmation-icon">
      <i class="fas fa-check-circle"></i>
    </div>
    <div class="confirmation-title" data-i18n="successTitle">Thanh toán thành công!</div>
    <div class="confirmation-message">
      <span data-i18n="thanksLine1">Cảm ơn bạn đã sử dụng dịch vụ của SkyPlan.</span><br>
      <span data-i18n="thanksLine2">Thông tin đặt vé của bạn đã được xác nhận.</span>
    </div>
    <div class="confirmation-details" id="confirmationDetails">
      <div><strong data-i18n="bookingCodeLabel">Mã vé:</strong> <span id="bookingCode" data-i18n="bookingCodeValue">Đang cập nhật...</span></div>
      <div><strong data-i18n="txnRefLabel">Mã giao dịch:</strong> <span id="txnRef" data-i18n="txnRefValue">Đang cập nhật...</span></div>
      <div><strong data-i18n="amountLabel">Số tiền:</strong> <span id="amount" data-i18n="amountValue">Đang cập nhật...</span></div>
    </div>
    <div class="confirmation-actions">
      <button id="downloadTicketBtn" class="download-btn"><i class="fas fa-download"></i> <span data-i18n="downloadTicket">Tải vé</span></button>
      <a href="index.html"><i class="fas fa-home"></i> <span data-i18n="backHome">Về trang chủ</span></a>
      <a href="overview.html"><i class="fas fa-ticket-alt"></i> <span data-i18n="viewMyTicket">Xem vé của tôi</span></a>
    </div>
  </div>
  <div id="footer-container"></div>
  <script src="assets/scripts/config.js"></script>
  <script src="assets/scripts/confirmation.js"></script>
  <script>
    // Load header/footer
    fetch('components/header.html').then(r=>r.text()).then(html=>{
      document.getElementById('header-container').innerHTML = html;
      if (typeof initializeLanguageSelector === 'function') initializeLanguageSelector();
      if (typeof initializeMobileMenu === 'function') initializeMobileMenu();
      const lang = localStorage.getItem('preferredLanguage') || document.documentElement.lang || 'vi';
      if (typeof applyConfirmationTranslations === 'function') applyConfirmationTranslations(lang);
      if (typeof updateSelectedLanguage === 'function') updateSelectedLanguage(lang);
    });
    fetch('components/footer.html').then(r=>r.text()).then(html=>{
      document.getElementById('footer-container').innerHTML = html;
      const lang = localStorage.getItem('preferredLanguage') || document.documentElement.lang || 'vi';
      if (typeof applyConfirmationTranslations === 'function') applyConfirmationTranslations(lang);
    });
    // Lấy thông tin từ query string
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    // Nếu không có trên URL, lấy từ localStorage (lưu từ payment.js)
    let txnRef = getQueryParam('txnRef');
    let amount = getQueryParam('amount');
    if (!txnRef || !amount) {
      txnRef = localStorage.getItem('lastTxnRef') || 'None';
      amount = localStorage.getItem('lastAmount') || 'None';
    }
    document.getElementById('txnRef').textContent = txnRef;
    document.getElementById('amount').textContent = amount !== 'None' ? Number(amount).toLocaleString('vi-VN') + ' VND' : 'None';
    // Lấy mã vé từ localStorage (ưu tiên), hoặc từ URL nếu có
    let bookingCode = getQueryParam('bookingCode');
    if (!bookingCode) {
      bookingCode = localStorage.getItem('lastTxnRef') || 'None';
    }
    document.getElementById('bookingCode').textContent = bookingCode;
    // Apply i18n on initial load
    document.addEventListener('DOMContentLoaded', function() {
      const lang = localStorage.getItem('preferredLanguage') || 'vi';
      if (typeof applyConfirmationTranslations === 'function') applyConfirmationTranslations(lang);
      
      // Thêm loader cho các link navigation
      const links = document.querySelectorAll('.confirmation-actions a');
      links.forEach(function(link) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const href = this.getAttribute('href');
          if (window.Loader) {
            window.Loader.show();
            setTimeout(function() {
              window.location.href = href;
            }, 1500);
          } else {
            window.location.href = href;
          }
        });
      });
    });
  </script>

  <!-- Loader component (JS) -->
  <script src="assets/scripts/loader.js"></script>
  <script>
    // Import loader HTML vào DOM càng sớm càng tốt
    fetch('components/loader.html').then(r => r.text()).then(html => {
      document.body.insertAdjacentHTML('afterbegin', html);
      // Show loader ngay khi vừa insert vào DOM (cho F5/reload)
      if (window.Loader) {
        window.Loader.show();
        document.body.style.overflow = 'hidden';
      }
    });
    
    // Ẩn loader khi tất cả resources đã load xong (window.load)
    window.addEventListener('load', function() {
      setTimeout(function() {
        if (window.Loader) {
          window.Loader.hide();
          document.body.style.overflow = '';
        }
      }, 500); // Delay 500ms để smooth
    });
  </script>
</body>
</html>
