const searchTranslations = {
    en: {
        // Header
        helpText: "Help",
        myTripsText: "My Trips",
        signInText: "Sign Up",
        logInText: "Sign In",
        // Trip type
        roundTrip: "Round-trip",
        oneWay: "One-way",
        // Footer
        footerDesc: "Your trusted travel companion for the best flight deals and unforgettable journeys.",
        quickLinksTitle: "Quick Links",
        aboutUs: "About Us",
        contact: "Contact",
        privacyPolicy: "Privacy Policy",
        termsOfService: "Terms of Service",
        supportTitle: "Support",
        helpCenter: "Help Center",
        customerService: "Customer Service",
        bookingHelp: "Booking Help",
        faq: "FAQ",
        paymentMethodsTitle: "Payment Methods",
        downloadAppTitle: "Download our app",
        appStore: "App Store",
        googlePlay: "Google Play",
        copyright: "© 2024 SkyPlan. All rights reserved.",
        // Titles & labels
        searchTitle: "Your trip",
        fromLabel: "From",
        toLabel: "To",
        departureLabel: "Departure date",
        returnLabel: "Return date",
        searchButton: "Search",
        filtersTitle: "Filters",
        stopsTitle: "Number of stops",
        baggageTitle: "Baggage",
        carryOn: "Carry-on baggage",
        checkedBag: "Checked baggage",
        timeTitle: "Departure time",
        budgetTitle: "Budget",
        anyLabel: "Any",
        // Options
        nonstop: "Nonstop",
        oneStop: "1 stop",
        twoStops: "2 stops",
        threeStops: "3 stops",
        // Cards / Modal CTA
        selectFlight: "Select flight",
        shareTrip: "Share trip",
        bookNowFor: "Book now for",
        bookNowFrom: "Book now from",
        // Modal title
        modalTitle: "",
        legTo: "",
        // Inline markers
        dotDeparture: "Departure",
        dotReturn: "Return",
        // Airport codes
        airportHAN: "Ha Noi (HAN)",
        airportSGN: "Ho Chi Minh (SGN)",
        airportDAD: "Da Nang (DAD)",
        airportCXR: "Cam Ranh (CXR)",
        airportPQC: "Phu Quoc (PQC)",
        airportVCA: "Can Tho (VCA)",
        airportVCS: "Con Dao (VCS)",
        airportUIH: "Phu Cat (UIH)",
        airportBMV: "Buon Ma Thuot (BMV)",
        airportVDH: "Dong Hoi (VDH)",
        airportHPH: "Cat Bi (HPH)",
        airportHUI: "Phu Bai (HUI)",
        airportVII: "Vinh (VII)",
        airportVDO: "Van Don (VDO)",
        airportTHD: "Tho Xuan (THD)",
        airportDLI: "Lien Khuong (DLI)",
        airportDIN: "Dien Bien (DIN)",
        airportPXU: "Pleiku (PXU)",
        airportVKG: "Rach Gia (VKG)",
        airportSQH: "Na San (SQH)",
        airportVCL: "Chu Lai (VCL)",
        airportTBB: "Tuy Hoa (TBB)",
    },
    vi: {
        // Header
        helpText: "Trợ giúp",
        myTripsText: "Chuyến đi của tôi",
        signInText: "Đăng ký",
        logInText: "Đăng nhập",
        // Trip type
        roundTrip: "Khứ hồi",
        oneWay: "Một chiều",
        // Footer
        footerDesc: "Đối tác du lịch đáng tin cậy của bạn cho các ưu đãi vé máy bay tốt nhất và những hành trình khó quên.",
        quickLinksTitle: "Liên kết nhanh",
        aboutUs: "Về chúng tôi",
        contact: "Liên hệ",
        privacyPolicy: "Chính sách bảo mật",
        termsOfService: "Điều khoản dịch vụ",
        supportTitle: "Hỗ trợ",
        helpCenter: "Trung tâm trợ giúp",
        customerService: "Dịch vụ khách hàng",
        bookingHelp: "Hỗ trợ đặt vé",
        faq: "Câu hỏi thường gặp",
        paymentMethodsTitle: "Phương thức thanh toán",
        downloadAppTitle: "Tải ứng dụng của chúng tôi",
        appStore: "App Store",
        googlePlay: "Google Play",
        copyright: "© 2024 SkyPlan. Bảo lưu mọi quyền.",
        // Titles & labels
        searchTitle: "Chuyến đi của bạn",
        fromLabel: "Từ",
        toLabel: "Đến",
        departureLabel: "Ngày đi",
        returnLabel: "Ngày về",
        searchButton: "Tìm kiếm",
        filtersTitle: "Bộ lọc",
        stopsTitle: "Số điểm dừng",
        baggageTitle: "Hành lý",
        carryOn: "Hành lý xách tay",
        checkedBag: "Hành lý ký gửi",
        timeTitle: "Giờ bay",
        budgetTitle: "Ngân sách",
        anyLabel: "Bất kỳ",
        // Options
        nonstop: "Bay thẳng",
        oneStop: "1 điểm dừng",
        twoStops: "2 điểm dừng",
        threeStops: "3 điểm dừng",
        // Cards / Modal CTA
        selectFlight: "Chọn chuyến bay",
        shareTrip: "Chia sẻ chuyến đi",
        bookNowFor: "Đặt ngay với giá",
        bookNowFrom: "Đặt ngay từ",
        // Modal title
        modalTitle: "",
        legTo: "",
        // Inline markers
        dotDeparture: "Khởi hành",
        dotReturn: "Về",
        // Airport codes
        airportHAN: "Hà Nội (HAN)",
        airportSGN: "Hồ Chí Minh (SGN)",
        airportDAD: "Đà Nẵng (DAD)",
        airportCXR: "Cam Ranh (CXR)",
        airportPQC: "Phú Quốc (PQC)",
        airportVCA: "Cần Thơ (VCA)",
        airportVCS: "Côn Đảo (VCS)",
        airportUIH: "Phù Cát (UIH)",
        airportBMV: "Buôn Ma Thuột (BMV)",
        airportVDH: "Đồng Hới (VDH)",
        airportHPH: "Cát Bi (HPH)",
        airportHUI: "Phú Bài (HUI)",
        airportVII: "Vinh (VII)",
        airportVDO: "Vân Đồn (VDO)",
        airportTHD: "Thọ Xuân (THD)",
        airportDLI: "Liên Khương (DLI)",
        airportDIN: "Điện Biên (DIN)",
        airportPXU: "Pleiku (PXU)",
        airportVKG: "Rạch Giá (VKG)",
        airportSQH: "Na Sản (SQH)",
        airportVCL: "Chu Lai (VCL)",
        airportTBB: "Tuy Hòa (TBB)",
    }
};

// Export (optional)
if (typeof module !== 'undefined' && module.exports) {
    module.exports = searchTranslations;
}

function _t(lang) { return searchTranslations[lang] || searchTranslations.vi; }

function _$(sel, ctx) { return (ctx || document).querySelector(sel); }

function _$all(sel, ctx) { return Array.prototype.slice.call((ctx || document).querySelectorAll(sel)); }

// Function to get the translated airport name based on airport code
function getAirportName(code, lang) {
    if (!code) return '';
    const dict = _t(lang || 'vi');
    const key = 'airport' + code.toUpperCase();
    return dict[key] || code;
}

// Expose the function globally
window.getAirportName = getAirportName;

// Áp dụng dịch cho trang search
function applySearchTranslations(lang) {
    const dict = _t(lang);
    const aside = _$('.sp-filters') || document;

    // 1) data-i18n (nếu bạn có gắn)
    _$all('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const val = dict[key];
        if (val == null) return;
        const attr = el.getAttribute('data-i18n-attr');
        if (attr === 'placeholder') el.placeholder = val;
        else if (attr) el.setAttribute(attr, val);
        else el.textContent = val;
    });

    // 2) Form & filters (không cần data-i18n)
    const setText = (sel, v, ctx) => { const el = _$(sel, ctx); if (el) el.textContent = v; };
    setText('.sp-title', dict.searchTitle, aside);
    setText('label[for="from"]', dict.fromLabel, aside);
    setText('label[for="to"]', dict.toLabel, aside);
    setText('label[for="dep"]', dict.departureLabel, aside);
    setText('label[for="ret"]', dict.returnLabel, aside);
    
    // Trip type radio buttons
    const tripLabels = _$all('.sp-trip-type .sp-radio span');
    if (tripLabels[0]) tripLabels[0].textContent = dict.roundTrip;
    if (tripLabels[1]) tripLabels[1].textContent = dict.oneWay;

    const searchBtn = _$('.sp-btn.sp-btn-secondary', aside);
    if (searchBtn) {
        const icon = searchBtn.querySelector('i');
        searchBtn.innerHTML = (icon ? icon.outerHTML + ' ' : '') + dict.searchButton;
        searchBtn.setAttribute('aria-label', dict.searchButton);
    }

    setText('.sp-subtitle', dict.filtersTitle, aside);

    const titles = _$all('.sp-filters .sp-section .sp-section-title', aside);
    if (titles[0]) titles[0].textContent = dict.stopsTitle;
    if (titles[1]) titles[1].textContent = dict.baggageTitle;
    if (titles[2]) titles[2].textContent = dict.timeTitle;
    if (titles[3]) titles[3].textContent = dict.budgetTitle;

    // Stops labels
    const stopLabels = _$all('.sp-filters .sp-section:nth-of-type(1) .sp-choice', aside);
    if (stopLabels[0] && stopLabels[0].lastChild) stopLabels[0].lastChild.nodeValue = ' ' + dict.nonstop;
    if (stopLabels[1] && stopLabels[1].lastChild) stopLabels[1].lastChild.nodeValue = ' ' + dict.oneStop;
    if (stopLabels[2] && stopLabels[2].lastChild) stopLabels[2].lastChild.nodeValue = ' ' + dict.twoStops;
    if (stopLabels[3] && stopLabels[3].lastChild) stopLabels[3].lastChild.nodeValue = ' ' + dict.threeStops;

    // Baggage + aria
    const bagCounters = _$all('.sp-filters .sp-section:nth-of-type(2) .sp-counter', aside);
    if (bagCounters[0]) {
        const span = bagCounters[0].querySelector('span');
        if (span) span.textContent = dict.carryOn;
        const minus = bagCounters[0].querySelector('[data-minus]');
        const plus = bagCounters[0].querySelector('[data-plus]');
        if (minus) minus.setAttribute('aria-label', lang === 'vi' ? 'giảm xách tay' : 'decrease cabin');
        if (plus) plus.setAttribute('aria-label', lang === 'vi' ? 'tăng xách tay' : 'increase cabin');
    }
    if (bagCounters[1]) {
        const span = bagCounters[1].querySelector('span');
        if (span) span.textContent = dict.checkedBag;
        const minus = bagCounters[1].querySelector('[data-minus]');
        const plus = bagCounters[1].querySelector('[data-plus]');
        if (minus) minus.setAttribute('aria-label', lang === 'vi' ? 'giảm ký gửi' : 'decrease checked');
        if (plus) plus.setAttribute('aria-label', lang === 'vi' ? 'tăng ký gửi' : 'increase checked');
    }

    const anyEl = _$('.sp-price-top span:last-child', aside);
    if (anyEl) anyEl.textContent = dict.anyLabel;

    // 3) Cards
    _$all('.sp-card .sp-btn.sp-btn-block').forEach(btn => {
        btn.textContent = dict.selectFlight;
        btn.setAttribute('aria-label', dict.selectFlight);
    });

    _$all('.sp-card .sp-date').forEach(el => {
        const raw = el.textContent;
        el.textContent = raw
            .replace(/·\s*Khởi hành/gi, dict.dotDeparture)
            .replace(/·\s*Về/gi, dict.dotReturn)
            .replace(/·\s*Departure/gi, dict.dotDeparture)
            .replace(/·\s*Return/gi, dict.dotReturn);
    });

    _$all('.sp-duration').forEach(el => {
        const parts = String(el.innerHTML).split('<br>');
        if (parts.length === 2) {
            parts[1] = dict.nonstop;
            el.innerHTML = parts.join('<br>');
        } else {
            el.innerHTML = String(el.innerHTML).replace(/Bay thẳng|Nonstop/gi, dict.nonstop);
        }
    });

    // 4) Modal
    const modal = _$('#spModal');
    if (modal) {
        const setM = (sel, v) => { const el = _$(sel, modal); if (el) el.textContent = v; };
        setM('#spModalTitle', dict.modalTitle || 'Chi tiết chuyến bay'); // có thể không có key thì để trống

        _$all('.sp-leg__title', modal).forEach(tEl => {
            const span = tEl.querySelector('span');
            const city = span ? span.outerHTML : '';
            tEl.innerHTML = `${dict.legTo} ${city}`.trim();
        });

        const shareBtn = _$('.sp-modal__footer .sp-btn.sp-btn--ghost', modal);
        if (shareBtn) {
            shareBtn.textContent = dict.shareTrip;
            shareBtn.setAttribute('aria-label', dict.shareTrip);
        }

        const bookBtn = _$('#spBookBtn', modal);
        if (bookBtn) {
            // Prefer numeric price if provided by runtime
            const num = Number(bookBtn.getAttribute('data-total-price') || '');
            if (!isNaN(num) && num > 0) {
                const priceText = `${num.toLocaleString('vi-VN')} VND`;
                bookBtn.textContent = `${dict.bookNowFor} ${priceText}`;
            } else {
                // Fallback: parse from existing text (legacy)
                const txt = (bookBtn.textContent || '').trim();
                const m = txt.match(/([\d\s.,]+(?:VND|₫|USD|€|£))/i);
                if (m) {
                    bookBtn.textContent = `${dict.bookNowFor} ${m[1]}`;
                } else {
                    bookBtn.textContent = dict.bookNowFor;
                }
            }
        }
    }

    // 5) <html lang> + <title>
    if (dict.searchTitle) document.title = dict.searchTitle;
    document.documentElement.lang = (lang === 'en' ? 'en' : 'vi');
}

// Cập nhật tất cả thông tin sân bay trên trang
function updateAllAirportInfo() {
    // Cập nhật tất cả các thông tin sân bay hiển thị trong DOM
    _$all('[data-out-dep-airport], [data-out-arr-airport], [data-in-dep-airport], [data-in-arr-airport]').forEach(el => {
        // Trích xuất mã sân bay từ nội dung (nếu có)
        const airportCode = el.textContent.match(/\(([A-Z]{3})\)/i);
        if (airportCode && airportCode[1]) {
            const code = airportCode[1];
            // Tìm tên thành phố nếu có
            const cityMatch = el.textContent.match(/^(.*?)\s*\([A-Z]{3}\)/i);
            const cityName = cityMatch ? cityMatch[1].trim() : '';
            
            // Cập nhật lại nội dung với bản dịch mới
            if (typeof window.displayAirport === 'function') {
                el.innerHTML = window.displayAirport(cityName, code);
            }
        }
    });
}

// Đổi ngôn ngữ (public API cho trang search)
function changeSearchLanguage(lang) {
    const next = (lang === 'en' || lang === 'vi') ? lang : 'vi';
    try { localStorage.setItem('preferredLanguage', next); } catch (_) {}
    document.documentElement.lang = next;
    applySearchTranslations(next);
    
    // Cập nhật labels khứ hồi/một chiều
    if (typeof updateTripTypeLabels === 'function') {
        try { updateTripTypeLabels(); } catch (e) { console.error('Error updating trip types:', e); }
    }

    // Cập nhật thông tin sân bay
    try { updateAllAirportInfo(); } catch (e) { console.error('Error updating airport info:', e); }
    
    // Reload flights with new language if available
    reloadFlights();

    if (typeof updateSelectedLanguage === 'function') {
        try { updateSelectedLanguage(next); } catch (_) {}
    }
}

// Expose cho common.js & fallback
window.changeSearchLanguage = changeSearchLanguage;
window.changeLanguage = changeSearchLanguage; // alias thường dùng

// Dùng từ điển đa ngôn ngữ mới trong search.js (AIRPORT_NAMES, CITY_NAMES)

// Mặc định VI lần đầu
if (!localStorage.getItem('preferredLanguage')) {
    localStorage.setItem('preferredLanguage', 'vi');
}

// Function để init translations sau khi components đã load
function initSearchTranslations() {
    const qLang = new URLSearchParams(location.search).get('lang');
    const lang = (qLang === 'en' || qLang === 'vi') ?
        qLang :
        (localStorage.getItem('preferredLanguage') || 'vi');

    applySearchTranslations(lang);

    // Fallback click .lang-option nếu không dùng common.js
    if (!window.__search_lang_bound) {
        document.addEventListener('click', (e) => {
            const btn = e.target.closest && e.target.closest('.lang-option');
            if (!btn) return;
            e.preventDefault();
            const next = btn.getAttribute('data-lang') || 'vi';
            changeSearchLanguage(next);
        });
        window.__search_lang_bound = true;
    }

    // Fallback <select id="languageSelect">
    const sel = document.getElementById('languageSelect');
    if (sel && !sel.__bound) {
        sel.addEventListener('change', () => changeSearchLanguage(sel.value));
        sel.__bound = true;
    }
}

// Function to reload flights when language changes
function reloadFlights() {
    // If fetchFlights exists, call it to reload with the new language
    console.log("reloadFlights() called");
    if (typeof window.fetchFlights === 'function') {
        console.log("Calling window.fetchFlights()");
        window.fetchFlights();
    } else {
        console.warn("fetchFlights is not defined on window object!");
    }
}

// Expose functions
window.initSearchTranslations = initSearchTranslations;
window.reloadFlights = reloadFlights;

// ====== Airport dictionaries & helpers (moved from search.js) ======
// Mapping mã sân bay -> tên đầy đủ theo ngôn ngữ
const AIRPORT_NAMES = {
  vi: {
    HAN: 'Sân bay quốc tế Nội Bài',
    SGN: 'Sân bay quốc tế Tân Sơn Nhất',
    DAD: 'Sân bay quốc tế Đà Nẵng',
    CXR: 'Sân bay quốc tế Cam Ranh',
    PQC: 'Sân bay quốc tế Phú Quốc',
    VCA: 'Sân bay quốc tế Cần Thơ',
    VCS: 'Sân bay Côn Đảo',
    UIH: 'Sân bay Phù Cát',
    BMV: 'Sân bay Buôn Ma Thuột',
    VDH: 'Sân bay Đồng Hới',
    HPH: 'Sân bay quốc tế Cát Bi',
    HUI: 'Sân bay Phú Bài',
    VII: 'Sân bay Vinh',
    VDO: 'Sân bay Vân Đồn',
    THD: 'Sân bay Thọ Xuân',
    DLI: 'Sân bay quốc tế Liên Khương',
    DIN: 'Sân bay Điện Biên',
    PXU: 'Sân bay Pleiku',
    VKG: 'Sân bay Rạch Giá',
    SQH: 'Sân bay Na Sản',
    VCL: 'Sân bay Chu Lai',
    TBB: 'Sân bay Tuy Hòa'
  },
  en: {
    HAN: 'Noi Bai International Airport',
    SGN: 'Tan Son Nhat International Airport',
    DAD: 'Da Nang International Airport',
    CXR: 'Cam Ranh International Airport',
    PQC: 'Phu Quoc International Airport',
    VCA: 'Can Tho International Airport',
    VCS: 'Con Dao Airport',
    UIH: 'Phu Cat Airport',
    BMV: 'Buon Ma Thuot Airport',
    VDH: 'Dong Hoi Airport',
    HPH: 'Cat Bi International Airport',
    HUI: 'Phu Bai International Airport',
    VII: 'Vinh Airport',
    VDO: 'Van Don International Airport',
    THD: 'Tho Xuan Airport',
    DLI: 'Lien Khuong International Airport',
    DIN: 'Dien Bien Airport',
    PXU: 'Pleiku Airport',
    VKG: 'Rach Gia Airport',
    SQH: 'Na San Airport',
    VCL: 'Chu Lai Airport',
    TBB: 'Tuy Hoa Airport'
  }
};

// Mapping mã -> tên thành phố theo ngôn ngữ
const CITY_NAMES = {
  vi: {
    HAN: 'Hà Nội', SGN: 'Hồ Chí Minh', DAD: 'Đà Nẵng', CXR: 'Cam Ranh', PQC: 'Phú Quốc',
    VCA: 'Cần Thơ', VCS: 'Côn Đảo', UIH: 'Phù Cát', BMV: 'Buôn Ma Thuột', VDH: 'Đồng Hới',
    HPH: 'Hải Phòng', HUI: 'Huế', VII: 'Vinh', VDO: 'Vân Đồn', THD: 'Thọ Xuân', DLI: 'Đà Lạt',
    DIN: 'Điện Biên', PXU: 'Pleiku', VKG: 'Rạch Giá', SQH: 'Sơn La', VCL: 'Chu Lai', TBB: 'Tuy Hòa'
  },
  en: {
    HAN: 'Ha Noi', SGN: 'Ho Chi Minh City', DAD: 'Da Nang', CXR: 'Cam Ranh', PQC: 'Phu Quoc',
    VCA: 'Can Tho', VCS: 'Con Dao', UIH: 'Phu Cat', BMV: 'Buon Ma Thuot', VDH: 'Dong Hoi',
    HPH: 'Hai Phong', HUI: 'Hue', VII: 'Vinh', VDO: 'Van Don', THD: 'Tho Xuan', DLI: 'Da Lat',
    DIN: 'Dien Bien', PXU: 'Pleiku', VKG: 'Rach Gia', SQH: 'Son La', VCL: 'Chu Lai', TBB: 'Tuy Hoa'
  }
};

function formatAirport(code) {
  const lang = localStorage.getItem('preferredLanguage') || 'vi';
  const city = (window.CITY_NAMES && window.CITY_NAMES[lang] && window.CITY_NAMES[lang][code]) || null;
  return city ? `${city} (${code})` : (code || '—');
}

// Helper ưu tiên tên thành phố từ API để khớp dataset; fallback sang map tĩnh nếu thiếu
function displayAirport(cityName, code) {
  const lang = localStorage.getItem('preferredLanguage') || 'vi';
  const cityLabel = (window.CITY_NAMES && window.CITY_NAMES[lang] && window.CITY_NAMES[lang][code]) || cityName || code || '—';
  const top = code ? `${cityLabel} (${code})` : cityLabel;
  const airportName = (window.AIRPORT_NAMES && window.AIRPORT_NAMES[lang] && window.AIRPORT_NAMES[lang][code]) || null;
  if (airportName) {
    return `<div class="airport-info"><div class="airport-code">${top}</div><div class="airport-name">${airportName}</div></div>`;
  }
  return top;
}

// Trip-type labels updater
function updateTripTypeLabels() {
  const lang = localStorage.getItem('preferredLanguage') || 'vi';
  const dict = (typeof searchTranslations !== 'undefined' && (searchTranslations[lang] || searchTranslations.vi)) || { roundTrip: 'Khứ hồi', oneWay: 'Một chiều' };
  const tripLabels = document.querySelectorAll('.sp-trip-type .sp-radio span');
  if (tripLabels[0]) tripLabels[0].textContent = dict.roundTrip || 'Khứ hồi';
  if (tripLabels[1]) tripLabels[1].textContent = dict.oneWay || 'Một chiều';
}

// Expose globally
window.AIRPORT_NAMES = AIRPORT_NAMES;
window.CITY_NAMES = CITY_NAMES;
window.formatAirport = formatAirport;
window.displayAirport = displayAirport;
window.updateTripTypeLabels = updateTripTypeLabels;

